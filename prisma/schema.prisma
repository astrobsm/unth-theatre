// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  SYSTEM_ADMINISTRATOR
  THEATRE_MANAGER
  THEATRE_CHAIRMAN
  CHIEF_MEDICAL_DIRECTOR
  CMAC
  DC_MAC
  LAUNDRY_SUPERVISOR
  CSSD_SUPERVISOR
  OXYGEN_UNIT_SUPERVISOR
  WORKS_SUPERVISOR
  SURGEON
  ANAESTHETIST
  CONSULTANT_ANAESTHETIST
  SCRUB_NURSE
  RECOVERY_ROOM_NURSE
  THEATRE_STORE_KEEPER
  PORTER
  ANAESTHETIC_TECHNICIAN
  BIOMEDICAL_ENGINEER
  CLEANER
  PROCUREMENT_OFFICER
  BLOODBANK_STAFF
  PHARMACIST
  CSSD_STAFF
  POWER_PLANT_OPERATOR
  THEATRE_CAFETERIA_MANAGER
  LAUNDRY_STAFF
  PLUMBER
  LABORATORY_STAFF
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ItemCategory {
  CONSUMABLE
  MACHINE
  DEVICE
  OTHER
}

enum SurgeryStatus {
  SCHEDULED
  IN_HOLDING_AREA
  READY_FOR_THEATRE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SurgeryType {
  ELECTIVE
  URGENT
  EMERGENCY
}

enum SurgeryReadinessStatus {
  PENDING_CHECKS
  PENDING_DEPOSIT
  READY
  BLOCKED
}

enum AnesthesiaType {
  GENERAL
  SPINAL
  LOCAL
  REGIONAL
  SEDATION
}

enum EquipmentStatus {
  OPERATIONAL
  FAULTY
  UNDER_MAINTENANCE
  OUT_OF_SERVICE
}

enum MaintenanceInterval {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  AS_NEEDED
}

enum FaultStatus {
  REPORTED
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum FaultPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum SurgicalTeamRole {
  CONSULTANT
  SENIOR_REGISTRAR
  REGISTRAR
  HOUSE_OFFICER
}

enum PatientMovementPhase {
  WARD
  PORTER_DISPATCHED
  HOLDING_AREA
  INSIDE_THEATRE
  SURGERY_STARTED
  SURGERY_ENDED
  RECOVERY_ROOM
  RETURNED_TO_WARD
}

enum NotificationType {
  STOCK_ALERT
  EQUIPMENT_FAULT
  MAINTENANCE_DUE
  SURGERY_SCHEDULED
  FAULT_REPORTED
  REQUISITION_APPROVAL
  SYSTEM_ALERT
  RED_ALERT
  HOLDING_AREA_ALERT
  PACU_ALERT
  SAFETY_CONCERN
}

enum HoldingAreaStatus {
  ARRIVED
  VERIFICATION_IN_PROGRESS
  DISCREPANCY_FOUND
  RED_ALERT_ACTIVE
  CLEARED_FOR_THEATRE
  TRANSFERRED_TO_THEATRE
}

enum PACUDischargeReadiness {
  NOT_READY
  READY_WITH_CONCERNS
  READY_FOR_WARD
  DISCHARGED_TO_WARD
}

enum ConsciousnessLevel {
  FULLY_AWAKE
  DROWSY_BUT_ROUSABLE
  SEDATED
  UNCONSCIOUS
  UNRESPONSIVE
}

enum AirwayStatus {
  PATENT
  MAINTAINED
  COMPROMISED
  INTUBATED
  OXYGEN_THERAPY
}

enum RedAlertType {
  MISSING_DOCUMENTATION
  ABNORMAL_VITALS
  CONSENT_ISSUE
  SURGICAL_SITE_DISCREPANCY
  ALLERGY_CONCERN
  FASTING_VIOLATION
  IDENTITY_MISMATCH
  PACU_COMPLICATION
  RECOVERY_CONCERN
  OTHER
}

enum CancellationCategory {
  PATIENT_CONDITION
  EQUIPMENT_FAILURE
  STAFF_UNAVAILABILITY
  EMERGENCY_PRIORITY
  PATIENT_REQUEST
  ADMINISTRATIVE
  OTHER
}

enum IncidentType {
  ACCIDENT
  FIGHT
  THREATENING_SITUATION
  EQUIPMENT_FAILURE
  SAFETY_HAZARD
  FIRE
  SECURITY_BREACH
  PATIENT_FALL
  MEDICATION_ERROR
  OTHER
}

enum IncidentSeverity {
  MINOR
  MODERATE
  MAJOR
  CRITICAL
}

enum IncidentStatus {
  REPORTED
  UNDER_INVESTIGATION
  VERIFIED
  ACTION_TAKEN
  RESOLVED
  CLOSED
}

enum InvestigationUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum InvestigationStatus {
  REQUESTED
  SAMPLE_COLLECTED
  IN_LAB
  RESULTS_PENDING
  RESULTS_READY
  VERIFIED
  ABNORMAL
}

enum OxygenSupplyStatus {
  EXCELLENT
  GOOD
  ADEQUATE
  LOW
  CRITICAL
  DEPLETED
}

enum OxygenAlertSeverity {
  WARNING
  URGENT
  CRITICAL
  EMERGENCY
}

enum OxygenAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  CANCELLED
}

enum MortalityLocation {
  PREOPERATIVE
  INTRAOPERATIVE
  POSTOPERATIVE_RECOVERY
  POSTOPERATIVE_WARD
}

enum PatientLocation {
  WARD
  HOLDING_AREA
  THEATRE_SUITE
  RECOVERY
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

enum TheatreSuiteStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  RESERVED
}

enum DutyShift {
  MORNING
  CALL
  NIGHT
}

enum StaffCategory {
  NURSES
  ANAESTHETISTS
  PORTERS
  CLEANERS
  ANAESTHETIC_TECHNICIANS
}

enum AllocationType {
  SURGERY
  MAINTENANCE
  EMERGENCY
  RESERVED
}

enum TheatreSetupStatus {
  COLLECTED
  RETURNED
  IN_USE
}

enum ExtraRequestStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
}

model User {
  id            String      @id @default(uuid())
  staffId       String?     @unique
  username      String      @unique
  email         String?     @unique
  password      String
  fullName      String
  role          UserRole
  status        UserStatus  @default(PENDING)
  phoneNumber   String?
  department    String?
  staffCode     String?     @unique // Code for cleaners, porters, and other staff to log duties
  resetToken    String?     // Password reset token
  resetTokenExpiry DateTime? // Reset token expiration
  isFirstLogin  Boolean     @default(true) // Track if user has logged in before
  mustChangePassword Boolean @default(false) // Force password change on next login
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  approvedBy    String?
  approvedAt    DateTime?
  
  // Relations
  surgeries     Surgery[]   @relation("SurgeonSurgeries")
  assistingSurgeries Surgery[] @relation("AssistantSurgeries")
  anesthesiaSurgeries Surgery[] @relation("AnesthetistSurgeries")
  teamMemberSurgeries SurgicalTeamMember[] @relation("TeamMemberSurgeries")
  transfers     PatientTransfer[]
  cancellations CaseCancellation[]
  maintenanceLogs MaintenanceLog[]
  auditLogs     AuditLog[]
  whoChecklists WHOChecklist[] @relation("WHOChecklists")
  theatreSetups TheatreSetup[]
  setupReturns  TheatreSetupReturn[]
  extraRequests TheatreExtraRequest[]
  
  // Theatre Allocation Staff Relations
  scrubNurseAllocations TheatreAllocation[] @relation("ScrubNurseAllocations")
  circulatingNurseAllocations TheatreAllocation[] @relation("CirculatingNurseAllocations")
  anaestheticTechnicianAllocations TheatreAllocation[] @relation("AnaestheticTechnicianAllocations")
  anaesthetistConsultantAllocations TheatreAllocation[] @relation("AnaesthetistConsultantAllocations")
  anaesthetistSeniorRegistrarAllocations TheatreAllocation[] @relation("AnaesthetistSeniorRegistrarAllocations")
  anaesthetistRegistrarAllocations TheatreAllocation[] @relation("AnaesthetistRegistrarAllocations")
  cleanerAllocations TheatreAllocation[] @relation("CleanerAllocations")
  porterAllocations TheatreAllocation[] @relation("PorterAllocations")
  
  // Staff Duty Tracking Relations
  cleaningLogs  TheatreCleaningLog[]
  transportLogs PatientTransportLog[]
  dutyLogs      StaffDutyLog[]
  technicianSetupLogs AnesthesiaSetupLog[] @relation("TechnicianSetupLogs")
  rosterAssignments Roster[]
  storeKeeperCheckouts EquipmentCheckout[] @relation("StoreKeeperCheckouts")
  reportedFaults    EquipmentFaultAlert[] @relation("ReportedFaults")
  
  // Pre-Operative Review & Prescription Relations
  anesthetistReviews PreOperativeAnestheticReview[] @relation("AnesthetistReviews")
  consultantReviews PreOperativeAnestheticReview[] @relation("ConsultantReviews")
  prescribedPrescriptions AnestheticPrescription[] @relation("PrescribedBy")
  approvedPrescriptions AnestheticPrescription[] @relation("ApprovedBy")
  packedPrescriptions AnestheticPrescription[] @relation("PackedBy")
  
  // Blood Request Relations
  bloodRequestsRequested BloodRequest[] @relation("BloodRequestedBy")
  bloodRequestsAcknowledged BloodRequest[] @relation("BloodAcknowledgedBy")
  bloodRequestsPrepared BloodRequest[] @relation("BloodPreparedBy")
  
  // Emergency Alert Relations
  surgeonEmergencyAlerts EmergencySurgeryAlert[] @relation("SurgeonEmergencyAlerts")
  anesthetistEmergencyAlerts EmergencySurgeryAlert[] @relation("AnesthetistEmergencyAlerts")
  notifications Notification[]
  
  // Emergency Booking Relations
  emergencyBookingsAsSurgeon EmergencySurgeryBooking[] @relation("EmergencyBookingSurgeon")
  emergencyBookingsAsAnesthetist EmergencySurgeryBooking[] @relation("EmergencyBookingAnesthetist")
  
  // CSSD Relations
  cssdInventoryUpdates CssdInventory[]
  cssdUsageIssued CssdUsageHistory[] @relation("IssuedBy")
  cssdUsageReturned CssdUsageHistory[] @relation("ReturnedBy")
  cssdSterilizationLogs CssdSterilizationLog[]
  cssdSterilizationVerified CssdSterilizationLog[] @relation("VerifiedBy")
  cssdReadinessReports CssdReadinessReport[]
  cssdReadinessApproved CssdReadinessReport[] @relation("ApprovedBy")
  
  // Power House Relations
  powerHouseStatus PowerHouseStatus[]
  powerFuelConsumption PowerFuelConsumption[]
  powerMaintenanceLogs PowerMaintenanceLog[]
  powerMaintenanceSupervised PowerMaintenanceLog[] @relation("Supervisor")
  powerReadinessReports PowerReadinessReport[]
  powerReadinessApproved PowerReadinessReport[] @relation("ApprovedBy")
  
  // Incident Report Relations
  incidentsReported IncidentReport[] @relation("IncidentReporter")
  incidentsInvestigated IncidentReport[] @relation("IncidentInvestigator")
  incidentsVerified IncidentReport[] @relation("IncidentVerifier")
  
  // Laundry Relations
  laundryReadinessReports LaundryReadiness[]
  
  // Water Supply Relations
  waterSupplyLogs WaterSupplyLog[]
  
  // Theatre Sub-Store Relations
  subStoresManaged TheatreSubStore[] @relation("SubStoreManager")
  subStoresMorningCheck TheatreSubStore[] @relation("MorningCheck")
  subStoresEndOfDayCheck TheatreSubStore[] @relation("EndOfDayCheck")
  subStoreUsagesLogged SubStoreUsageLog[] @relation("UsageLoggedBy")
  subStoreUsagesVerified SubStoreUsageLog[] @relation("UsageVerifiedBy")
  restockRequestsRequested SubStoreRestockRequest[] @relation("RestockRequester")
  restockRequestsApproved SubStoreRestockRequest[] @relation("RestockApprover")
  restockRequestsFulfilled SubStoreRestockRequest[] @relation("RestockFulfiller")
  
  // Stock Transfer Relations
  stockTransfersRequested StockTransfer[] @relation("TransferRequester")
  stockTransfersApproved StockTransfer[] @relation("TransferApprover")
  stockTransfersIssued StockTransfer[] @relation("TransferIssuer")
  stockTransfersReceived StockTransfer[] @relation("TransferReceiver")
  
  // Pre-operative Investigation Relations
  investigationsRequested PreoperativeInvestigation[] @relation("InvestigationRequester")
  samplesCollected PreoperativeInvestigation[] @relation("SampleCollector")
  resultsVerified PreoperativeInvestigation[] @relation("ResultsVerifier")
  
  // Theatre Meal Relations
  theatreMeals TheatreMeal[]
  mealsPrepared TheatreMeal[] @relation("MealPreparer")
  
  // Oxygen Control Room Relations
  oxygenReadinessReports OxygenReadinessReport[]
  oxygenReportsVerified OxygenReadinessReport[] @relation("OxygenReportVerifier")
  oxygenAlertsTriggered OxygenAlert[] @relation("OxygenAlertTriggerer")
  oxygenAlertsAcknowledged OxygenAlert[] @relation("OxygenAlertAcknowledger")
  oxygenAlertsResponded OxygenAlert[] @relation("OxygenAlertResponder")
  oxygenAlertsResolved OxygenAlert[] @relation("OxygenAlertResolver")
  
  // Disciplinary Query Relations
  disciplinaryQueriesReceived DisciplinaryQuery[] @relation("QueryRecipient")
  disciplinaryQueriesIssued DisciplinaryQuery[] @relation("QueryIssuer")
  
  // Emergency Team Availability Relations
  emergencyTeamAvailability EmergencyTeamAvailability[]
  
  // Emergency Pre-Anaesthetic Review Relations
  emergencyPreAnaestheticReviews EmergencyPreAnaestheticReview[] @relation("EmergencyReviewer")
  emergencyPreAnaestheticApprovals EmergencyPreAnaestheticReview[] @relation("EmergencyReviewApprover")
  emergencyPrescriptionsPacked EmergencyPrescription[] @relation("EmergencyPrescriptionPacker")
  
  // Call for Patient Relations
  callUpsInvited PatientCallUp[] @relation("CallUpInviter")
  callUpsRejected PatientCallUp[] @relation("CallUpRejecter")
  
  // Pre-Operative Visit Relations
  preOperativeVisits PreOperativeVisit[] @relation("PreOpVisitor")
  
  // Medication Tracking Relations
  medsCollected MedicationCollection[] @relation("MedicationCollector")
  medsDispensed MedicationCollection[] @relation("MedicationDispenser")
  reconciliationsPerformed MedicationReconciliation[] @relation("ReconciliationUser")
  medsReturned MedicationReturn[] @relation("MedicationReturner")
  medsReceived MedicationReturn[] @relation("MedicationReceiver")
  additionalMedRequestsMade AdditionalMedicationRequest[] @relation("AdditionalMedRequester")
  additionalMedRequestsAcknowledged AdditionalMedicationRequest[] @relation("AdditionalMedAcknowledger")
  additionalMedRequestsPacked AdditionalMedicationRequest[] @relation("AdditionalMedPacker")
  medQueriesReceived MedicationNonReturnQuery[] @relation("QueriedUser")
  medQueriesIssued MedicationNonReturnQuery[] @relation("QueryIssuer")
  
  @@map("users")
}

model Roster {
  id               String        @id @default(uuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffName        String        // Name from Excel upload
  staffCategory    StaffCategory // NURSES, ANAESTHETISTS, PORTERS, CLEANERS, ANAESTHETIC_TECHNICIANS
  date             DateTime      @db.Date
  theatreId        String?
  theatre          TheatreSuite? @relation(fields: [theatreId], references: [id], onDelete: SetNull)
  shift            DutyShift     // MORNING, CALL, NIGHT
  uploadedBy       String
  uploadedAt       DateTime      @default(now())
  notes            String?       @db.Text

  @@index([date, theatreId, shift])
  @@index([staffCategory, date])
  @@map("rosters")
}

model InventoryItem {
  id            String        @id @default(uuid())
  name          String
  category      ItemCategory
  description   String?
  unitCostPrice Decimal       @db.Decimal(10, 2)
  quantity      Int
  reorderLevel  Int           @default(10)
  supplier      String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Equipment Maintenance Fields (for MACHINE and DEVICE categories)
  halfLife              Float?        // Equipment half-life in years
  depreciationRate      Float?        // Annual depreciation rate (percentage)
  deviceId              String?       // Unique device/machine identifier
  maintenanceIntervalDays Int?        // Days between maintenance
  lastMaintenanceDate   DateTime?     // Last maintenance performed
  nextMaintenanceDate   DateTime?     // Calculated next maintenance due date
  
  // Consumable Fields (for CONSUMABLE category)
  manufacturingDate     DateTime?     // Manufacturing date
  expiryDate            DateTime?     // Expiry date
  batchNumber           String?       // Batch/Lot number
  
  // Relations
  surgeryItems  SurgeryItem[]
  supplyRecords SupplyRecord[]
  maintenanceLogs MaintenanceLog[]
  maintenanceAlerts MaintenanceAlert[]
  theatreSetupItems TheatreSetupItem[]
  checkoutItems CheckoutItem[] @relation("CheckoutItems")
  
  @@map("inventory_items")
}

model SupplyRecord {
  id            String        @id @default(uuid())
  itemId        String
  quantity      Int
  costPrice     Decimal       @db.Decimal(10, 2)
  totalCost     Decimal       @db.Decimal(10, 2)
  supplier      String
  suppliedDate  DateTime      @default(now())
  createdAt     DateTime      @default(now())
  
  item          InventoryItem @relation(fields: [itemId], references: [id])
  
  @@map("supply_records")
}

model MaintenanceLog {
  id            String            @id @default(uuid())
  itemId        String
  description   String
  status        MaintenanceStatus
  scheduledDate DateTime
  completedDate DateTime?
  technician    String?
  cost          Decimal?          @db.Decimal(10, 2)
  notes         String?
  createdBy     String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  item          InventoryItem     @relation(fields: [itemId], references: [id])
  user          User              @relation(fields: [createdBy], references: [id])
  
  @@map("maintenance_logs")
}

model MaintenanceAlert {
  id              String    @id @default(uuid())
  itemId          String
  alertDate       DateTime  // Date when maintenance is due
  status          String    @default("PENDING") // PENDING, ACKNOWLEDGED, COMPLETED, DISMISSED
  acknowledged    Boolean   @default(false)
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  completedDate   DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  item            InventoryItem @relation(fields: [itemId], references: [id])
  
  @@map("maintenance_alerts")
}

model Patient {
  id            String    @id @default(uuid())
  folderNumber  String    @unique
  ptNumber      String?   @unique
  name          String
  age           Int
  gender        String
  ward          String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Preoperative Assessment Fields
  // DVT Risk Assessment
  dvtRiskScore          Int?       // DVT risk score
  hasDVTHistory         Boolean    @default(false)
  hasMobilityIssues     Boolean    @default(false)
  hasActiveCancer       Boolean    @default(false)
  hasPriorDVT           Boolean    @default(false)
  dDimerTestDone        Boolean    @default(false)
  dDimerResult          String?    // Result of D-dimer test
  dDimerValue           Float?     // Numeric value
  
  // Bleeding Risk Assessment
  bleedingRiskScore     Int?       // Bleeding risk score
  hasBleedingDisorder   Boolean    @default(false)
  hasLiverDisease       Boolean    @default(false)
  hasRenalImpairment    Boolean    @default(false)
  recentBleeding        Boolean    @default(false)
  
  // Pressure Sore Risk
  pressureSoreRisk      String?    // LOW, MEDIUM, HIGH
  hasPressureSores      Boolean    @default(false)
  mobilityStatus        String?    // Description of mobility
  nutritionalStatus     String?    // GOOD, FAIR, POOR
  
  // Medications Affecting Surgery
  onAnticoagulants      Boolean    @default(false)
  anticoagulantName     String?    // e.g., Warfarin, Heparin
  anticoagulantLastDose DateTime?
  onAntiplatelets       Boolean    @default(false)
  antiplateletName      String?    // e.g., Aspirin, Clopidogrel
  antiplateletLastDose  DateTime?
  onACEInhibitors       Boolean    @default(false)
  aceInhibitorName      String?
  aceInhibitorLastDose  DateTime?
  onARBs                Boolean    @default(false)
  arbName               String?
  arbLastDose           DateTime?
  otherMedications      String?    // Other relevant medications
  
  // WHO Operative Fitness Risk Assessment
  whoRiskClass          String?    // I, II, III, IV, V, VI
  asaScore              Int?       // 1-6 ASA classification
  comorbidities         String?    // List of comorbidities
  cardiovascularStatus  String?    // Assessment
  respiratoryStatus     String?    // Assessment
  metabolicStatus       String?    // Assessment
  
  // Final Assessment
  finalRiskScore        Int?       // Calculated final risk score (0-100)
  fitnessForSurgery     String?    // FIT, UNFIT, CONDITIONAL
  assessmentNotes       String?    // Additional notes
  assessedBy            String?    // User who completed assessment
  assessmentDate        DateTime?  // When assessment was completed
  
  // Relations
  surgeries     Surgery[]
  transfers     PatientTransfer[]
  fitnessAssessments PreoperativeFitnessAssessment[]
  mortalities   Mortality[]
  holdingAreaAssessments HoldingAreaAssessment[]
  pacuAssessments PACUAssessment[]
  anesthesiaRecords AnesthesiaMonitoringRecord[]
  transportLogs PatientTransportLog[]
  
  // New Relations for Enhanced Modules
  preOpReviews    PreOperativeAnestheticReview[] @relation("PatientPreOpReviews")
  prescriptions   AnestheticPrescription[] @relation("PatientPrescriptions")
  bloodRequests   BloodRequest[] @relation("PatientBloodRequests")
  
  // Pre-operative Investigation Relations
  investigations  PreoperativeInvestigation[]
  
  @@map("patients")
}

model Surgery {
  id                    String                  @id @default(uuid())
  patientId             String
  surgeonId             String?
  surgeonName           String?                 // Direct entry of surgeon name
  assistantSurgeonId    String?
  anesthetistId         String?
  scrubNurseId          String?
  subspecialty          String
  unit                  String                  // Surgical unit/department
  indication            String                  // Clinical indication
  procedureName         String
  scheduledDate         DateTime
  scheduledTime         String
  estimatedDuration     Int                     @default(60) // Estimated duration in minutes
  status                SurgeryStatus           @default(SCHEDULED)
  surgeryType           SurgeryType             @default(ELECTIVE)
  readinessStatus       SurgeryReadinessStatus  @default(PENDING_CHECKS)
  
  // Anesthesia
  anesthesiaType        AnesthesiaType?
  
  // Requirements
  needICU               Boolean                 @default(false)
  needBloodTransfusion  Boolean                 @default(false)
  needDiathermy         Boolean                 @default(false)
  needStereo            Boolean                 @default(false)
  needMontrellMattress  Boolean                 @default(false)
  needStirups           Boolean                 @default(false)
  needPneumaticTourniquet Boolean               @default(false)
  needCArm              Boolean                 @default(false)
  needMicroscope        Boolean                 @default(false)
  needSuction           Boolean                 @default(false)
  otherSpecialNeeds     String?
  remarks               String?
  
  // Costs
  totalItemsCost        Decimal?                @db.Decimal(10, 2)
  patientCharge         Decimal?                @db.Decimal(10, 2)
  depositAmount         Decimal?                @db.Decimal(10, 2)
  depositConfirmed      Boolean                 @default(false)
  
  // Timing
  knifeOnSkinTime       DateTime?
  surgeryEndTime        DateTime?
  completedAt           DateTime?
  actualStartTime       DateTime?
  actualEndTime         DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  // Relations
  patient               Patient                 @relation(fields: [patientId], references: [id])
  surgeon               User?                   @relation("SurgeonSurgeries", fields: [surgeonId], references: [id])
  assistantSurgeon      User?                   @relation("AssistantSurgeries", fields: [assistantSurgeonId], references: [id])
  anesthetist           User?                   @relation("AnesthetistSurgeries", fields: [anesthetistId], references: [id])
  items                 SurgeryItem[]
  whoChecklists         WHOChecklist[]
  cancellation          CaseCancellation?
  mortality             Mortality?
  consumptions          ConsumableConsumption[]
  movements             PatientMovement[]
  safetyCheck           PreoperativeSafetyCheck?
  holdingAreaAssessment HoldingAreaAssessment?
  intraOperativeRecord  IntraOperativeRecord?
  pacuAssessment        PACUAssessment?
  surgicalTiming        SurgicalTiming?
  surgicalCount         SurgicalCountChecklist?
  anesthesiaRecord      AnesthesiaMonitoringRecord?
  teamMembers           SurgicalTeamMember[]
  transportLogs         PatientTransportLog[]
  
  // New Relations for Enhanced Modules
  preOpReviews          PreOperativeAnestheticReview[] @relation("PreOpReviews")
  prescriptions         AnestheticPrescription[] @relation("SurgeryPrescriptions")
  bloodRequests         BloodRequest[] @relation("SurgeryBloodRequests")
  emergencyAlerts       EmergencySurgeryAlert[] @relation("EmergencyAlerts")
  cssdUsageHistory      CssdUsageHistory[]
  
  // Pre-operative Investigation Relations
  investigations        PreoperativeInvestigation[]
  
  // Oxygen Alert Relations
  oxygenAlerts          OxygenAlert[]
  
  // Emergency Booking Relation
  emergencyBooking      EmergencySurgeryBooking? @relation("EmergencyBookingSurgery")
  
  // Call for Patient Relations
  patientCallUps        PatientCallUp[]
  
  // Pre-Operative Visit Relations
  preOperativeVisits    PreOperativeVisit[]
  
  // Medication Tracking Relations
  medicationCollections MedicationCollection[] @relation("SurgeryMedicationCollections")
  medicationUsageRecords MedicationUsageRecord[] @relation("SurgeryMedicationUsage")
  medicationReconciliation MedicationReconciliation? @relation("SurgeryReconciliation")
  medicationReturns     MedicationReturn[] @relation("SurgeryMedicationReturns")
  additionalMedRequests AdditionalMedicationRequest[] @relation("SurgeryAdditionalMedRequests")
  medicationQueries     MedicationNonReturnQuery[] @relation("SurgeryMedicationQueries")
  
  @@map("surgeries")
}

model SurgicalTeamMember {
  id            String            @id @default(uuid())
  surgeryId     String
  userId        String?
  memberName    String?           // Direct entry of team member name
  role          SurgicalTeamRole
  specialNotes  String?
  createdAt     DateTime          @default(now())
  
  // Relations
  surgery       Surgery           @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  user          User?             @relation("TeamMemberSurgeries", fields: [userId], references: [id])
  
  @@map("surgical_team_members")
}

model SurgeryItem {
  id            String        @id @default(uuid())
  surgeryId     String
  itemId        String
  quantity      Int
  unitCost      Decimal       @db.Decimal(10, 2)
  totalCost     Decimal       @db.Decimal(10, 2)
  createdAt     DateTime      @default(now())
  
  surgery       Surgery       @relation(fields: [surgeryId], references: [id])
  item          InventoryItem @relation(fields: [itemId], references: [id])
  
  @@map("surgery_items")
}

model WHOChecklist {
  id                    String    @id @default(uuid())
  surgeryId             String
  
  // SIGN IN (To be read out loud) - Before induction of anaesthesia
  // At least nurse and anaesthetist
  patientConfirmed      Boolean?
  hasPatientConfirmedIdentity Boolean?
  hasPatientConfirmedSite Boolean?
  hasPatientConfirmedProcedure Boolean?
  hasPatientConfirmedConsent Boolean?
  siteMarked            Boolean?
  anesthesiaChecked     Boolean?
  isAnesthesiaSafetyCheckComplete Boolean?
  pulseOximeterOn       Boolean?
  isPulseOximeterOnPatient Boolean?
  pulseOximeterFunctioning Boolean?
  allergyChecked        Boolean?
  knownAllergy          Boolean?
  allergyDetails        String?
  difficultyAirwayRisk  Boolean?
  aspirationRisk        Boolean?
  riskOfBloodLoss       Boolean?
  bloodLossEstimate     String?   // e.g., ">500ml (7ml/kg in children)"
  twoIVAccessPlanned    Boolean?
  asaGrade              String?   // ASA grade (circle) 1 2 3 4 5
  signInNotes           String?
  
  // TIME OUT (To be read out loud) - Before skin incision
  // At least nurse, anaesthetist and surgeon
  haveTeamMembersIntroduced Boolean?
  teamIntroduced        Boolean?
  teamMembersByNameRole Boolean?
  
  // Surgeon, Anaesthetist and Nurse Verbally Confirm:
  confirmPatientName    Boolean?
  confirmProcedurePlanned Boolean?
  whatProcedureSiteFunctionPlanned String?
  
  // Anticipated Critical Events
  // TO SURGEON:
  criticalStepsReviewed Boolean?
  criticalOrUnexpectedSteps String?  // What are critical/unexpected steps you want team to know about?
  howMuchBloodlossAnticipated String?
  whatAnticipatedDurationOfSurgery String?
  anyEquipmentOrInvestigations String?  // Any specific equipment or special investigations required?
  
  // TO ANAESTHETIST:
  anyPatientSpecificConcerns String?  // Are there any patient specific concerns?
  
  // TO NURSE:
  equipmentConcerns     Boolean?
  hasSterilityBeenConfirmed Boolean?
  instrumentsSterilityConfirmed String?  // Has the sterility of the instruments been confirmed (including indicator results)?
  bloodAvailableForProcedure String?     // Is blood available for the procedure
  implantOrGadgetAvailable String?       // Implants are Gadget
  antibioticGiven       Boolean?
  antibioticsProphylaxisGiven String?    // Antibiotic prophylaxis given in last 60 min
  imagingDisplayed      Boolean?
  essentialImagingDisplayed String?      // Essential imaging displayed if applicable
  timeOutNotes          String?
  
  // SIGN OUT (To be read out loud) - Before any member of the team leaves the operating room
  // At least nurse, anaesthetist and surgeon
  nurseVerballyConfirms Boolean?
  procedureRecorded     Boolean?
  nameOfProcedurePerformed String?  // The name of the procedure performed
  instrumentCountCorrect Boolean?
  completionOfInstrumentCount String?   // Completion of instrument, sponge (swabs) and needle counts
  specimenLabeling      String?         // Specimen labelling (read aloud, including patient name)
  specimenLabeled       Boolean?
  whetherAnyEquipmentProblems String?   // Whether there are any equipment problems to be addressed
  equipmentProblems     Boolean?
  
  // TO SURGEON, ANAESTHETIST AND NURSE
  keyConcernsForRecovery String?        // What are the key concerns for recovery and management of this patient?
  breathingSpontaneously Boolean?
  vitalSignsNormalAndStable Boolean?
  postOperativeCareDecisions String?
  icuOrPcuCare          Boolean?
  airwayChallenge       Boolean?
  transferToRecoveryRoom Boolean?
  
  // Patient Details Section
  patientSurname        String?
  patientFirstName      String?
  patientHospitalNumber String?
  patientWard           String?
  surgicalOperation     String?
  checklistCompletedBy  String?         // Name and signature
  checklistCompletedAt  DateTime?
  surgeonName           String?
  surgeonSignature      String?
  surgeonDate           DateTime?
  anesthetistName       String?
  anesthetistSignature  String?
  anesthetistDate       DateTime?
  perioperativeNurseName String?
  perioperativeNurseSignature String?
  perioperativeNurseDate DateTime?
  
  signOutNotes          String?
  completedById         String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  surgery               Surgery   @relation(fields: [surgeryId], references: [id])
  completedBy           User?     @relation("WHOChecklists", fields: [completedById], references: [id])
  
  @@map("who_checklists")
}

model PreoperativeFitnessAssessment {
  id                String    @id @default(uuid())
  patientId         String
  assessmentDate    DateTime  @default(now())
  
  // Comorbidities
  diabetes          Boolean   @default(false)
  hypertension      Boolean   @default(false)
  heartDisease      Boolean   @default(false)
  asthma            Boolean   @default(false)
  kidneyDisease     Boolean   @default(false)
  liverDisease      Boolean   @default(false)
  otherComorbidities String?
  
  // Medications
  currentMedications String?
  allergies         String?
  
  // Assessment
  asaScore          Int?      // American Society of Anesthesiologists score
  fitnessLevel      String?   // "FIT", "FIT_WITH_PRECAUTIONS", "UNFIT"
  recommendations   String?
  assessedBy        String
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  patient           Patient   @relation(fields: [patientId], references: [id])
  
  @@map("preoperative_fitness_assessments")
}

model PatientTransfer {
  id            String          @id @default(uuid())
  patientId     String
  fromLocation  PatientLocation
  toLocation    PatientLocation
  transferTime  DateTime        @default(now())
  transferredBy String
  notes         String?
  
  patient       Patient         @relation(fields: [patientId], references: [id])
  user          User            @relation(fields: [transferredBy], references: [id])
  
  @@map("patient_transfers")
}

model CaseCancellation {
  id              String              @id @default(uuid())
  surgeryId       String              @unique
  reason          String
  category        CancellationCategory
  detailedNotes   String
  cancelledBy     String
  cancelledAt     DateTime            @default(now())
  
  surgery         Surgery             @relation(fields: [surgeryId], references: [id])
  user            User                @relation(fields: [cancelledBy], references: [id])
  
  @@map("case_cancellations")
}

model AuditLog {
  id            String    @id @default(uuid())
  userId        String
  action        String
  tableName     String
  recordId      String?
  changes       String?   // JSON string of changes
  ipAddress     String?
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
}

model TheatreSuite {
  id            String              @id @default(uuid())
  name          String              @unique
  location      String
  capacity      Int                 @default(1)
  equipment     String?             // JSON array of standard equipment
  status        TheatreSuiteStatus  @default(AVAILABLE)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  allocations   TheatreAllocation[]
  setups        TheatreSetup[]
  assignedEquipment Equipment[]
  cleaningLogs  TheatreCleaningLog[]
  setupLogs     AnesthesiaSetupLog[] @relation("TheatreSetupLogs")
  rosters       Roster[]
  
  @@map("theatre_suites")
}

model TheatreAllocation {
  id            String          @id @default(uuid())
  theatreId     String
  surgeryId     String?
  allocationType AllocationType
  startTime     DateTime
  endTime       DateTime
  date          DateTime
  allocatedBy   String
  notes         String?
  equipment     String?         // JSON array of specific equipment needed
  
  // Surgery-specific fields
  surgicalUnit  String?         // Operating surgical unit (e.g., CTU 1, Paediatric Surgery Unit 1)
  surgeryType   SurgeryType?    // ELECTIVE, URGENT, EMERGENCY
  
  // Staff assignments
  scrubNurseId          String?
  circulatingNurseId    String?
  anaestheticTechnicianId String?
  anaesthetistConsultantId String?
  anaesthetistSeniorRegistrarId String?
  anaesthetistRegistrarId String?
  cleanerId             String?
  porterId              String?
  shift                 DutyShift? // MORNING, CALL, NIGHT
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  theatre       TheatreSuite    @relation(fields: [theatreId], references: [id])
  scrubNurse    User?           @relation("ScrubNurseAllocations", fields: [scrubNurseId], references: [id])
  circulatingNurse User?        @relation("CirculatingNurseAllocations", fields: [circulatingNurseId], references: [id])
  anaestheticTechnician User?   @relation("AnaestheticTechnicianAllocations", fields: [anaestheticTechnicianId], references: [id])
  anaesthetistConsultant User?  @relation("AnaesthetistConsultantAllocations", fields: [anaesthetistConsultantId], references: [id])
  anaesthetistSeniorRegistrar User? @relation("AnaesthetistSeniorRegistrarAllocations", fields: [anaesthetistSeniorRegistrarId], references: [id])
  anaesthetistRegistrar User?   @relation("AnaesthetistRegistrarAllocations", fields: [anaesthetistRegistrarId], references: [id])
  cleaner       User?           @relation("CleanerAllocations", fields: [cleanerId], references: [id])
  porter        User?           @relation("PorterAllocations", fields: [porterId], references: [id])
  setupLogs     AnesthesiaSetupLog[] @relation("AllocationSetupLogs")
  
  @@map("theatre_allocations")
}

model Mortality {
  id                String            @id @default(uuid())
  surgeryId         String            @unique
  patientId         String
  timeOfDeath       DateTime
  location          MortalityLocation
  causeOfDeath      String
  contributingFactors String?
  resuscitationAttempted Boolean       @default(false)
  resuscitationDetails String?
  reportedBy        String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  surgery           Surgery           @relation(fields: [surgeryId], references: [id])
  patient           Patient           @relation(fields: [patientId], references: [id])
  audit             MortalityAudit?
  
  @@map("mortalities")
}

model MortalityAudit {
  id                String    @id @default(uuid())
  mortalityId       String    @unique
  auditDate         DateTime  @default(now())
  reviewedBy        String
  findings          String
  preventability    String?   // "PREVENTABLE", "POSSIBLY_PREVENTABLE", "NOT_PREVENTABLE"
  recommendations   String?
  actionsTaken      String?
  followUpRequired  Boolean   @default(false)
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  mortality         Mortality @relation(fields: [mortalityId], references: [id])
  
  @@map("mortality_audits")
}

model TheatreSetup {
  id                String              @id @default(uuid())
  theatreId         String
  collectedBy       String
  scrubNurseName    String?             // Name of scrub nurse collecting items
  setupDate         DateTime
  collectionTime    DateTime            @default(now())
  status            TheatreSetupStatus  @default(COLLECTED)
  
  // Geolocation
  latitude          Decimal?            @db.Decimal(10, 8)
  longitude         Decimal?            @db.Decimal(11, 8)
  location          String?
  
  // Legacy fixed items (kept for backward compatibility)
  // Antiseptics
  spiritQuantity    Int                 @default(0)
  savlonQuantity    Int                 @default(0)
  povidoneQuantity  Int                 @default(0)
  
  // Protective Equipment
  faceMaskQuantity  Int                 @default(0)
  nursesCapQuantity Int                 @default(0)
  
  // CSSD Supplies
  cssdGauzeQuantity Int                 @default(0)
  cssdCottonQuantity Int                @default(0)
  
  // Surgical Supplies
  surgicalBladesQuantity Int            @default(0)
  suctionTubbingsQuantity Int           @default(0)
  disposablesQuantity Int               @default(0)
  
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  theatre           TheatreSuite        @relation(fields: [theatreId], references: [id])
  nurse             User                @relation(fields: [collectedBy], references: [id])
  returns           TheatreSetupReturn[]
  items             TheatreSetupItem[]  // Dynamic items from inventory
  
  @@map("theatre_setups")
}

// New model to track flexible inventory items collected for theatre setup
model TheatreSetupItem {
  id              String       @id @default(uuid())
  setupId         String
  inventoryItemId String
  quantityTaken   Int
  createdAt       DateTime     @default(now())
  
  setup           TheatreSetup @relation(fields: [setupId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  
  @@map("theatre_setup_items")
}

model TheatreSetupReturn {
  id                String    @id @default(uuid())
  setupId           String
  returnedBy        String
  returnTime        DateTime  @default(now())
  
  // Returned quantities
  spiritReturned    Int       @default(0)
  savlonReturned    Int       @default(0)
  povidoneReturned  Int       @default(0)
  faceMaskReturned  Int       @default(0)
  nursesCapReturned Int       @default(0)
  cssdGauzeReturned Int       @default(0)
  cssdCottonReturned Int      @default(0)
  surgicalBladesReturned Int  @default(0)
  suctionTubbingsReturned Int @default(0)
  disposablesReturned Int     @default(0)
  
  returnReason      String
  notes             String?
  createdAt         DateTime  @default(now())
  
  setup             TheatreSetup @relation(fields: [setupId], references: [id])
  nurse             User         @relation(fields: [returnedBy], references: [id])
  
  @@map("theatre_setup_returns")
}

model TheatreExtraRequest {
  id                String              @id @default(uuid())
  theatreId         String
  requestedBy       String
  requestDate       DateTime            @default(now())
  status            ExtraRequestStatus  @default(PENDING)
  
  // Requested items
  itemName          String
  quantityRequested Int
  reason            String
  urgency           String?             // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  
  // Approval details
  approvedBy        String?
  approvedAt        DateTime?
  quantityApproved  Int?
  rejectionReason   String?
  
  // Fulfillment
  fulfilledBy       String?
  fulfilledAt       DateTime?
  quantityFulfilled Int?
  
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  requester         User                @relation(fields: [requestedBy], references: [id])
  
  @@map("theatre_extra_requests")
}

// ==================== ENHANCED MODELS ====================

model StoreConsumable {
  id                String    @id @default(uuid())
  name              String
  category          String
  unit              String              // e.g., "pieces", "boxes", "bottles"
  stockLevel        Int
  reorderLevel      Int       @default(10)
  expiryDate        DateTime?
  vendor            String?
  unitPrice         Decimal?  @db.Decimal(10, 2)
  batchNumber       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  consumptionRecords ConsumableConsumption[]
  
  @@map("store_consumables")
}

model ConsumableConsumption {
  id                String    @id @default(uuid())
  consumableId      String
  surgeryId         String?
  scrubNurseId      String
  quantityIssued    Int
  quantityReturned  Int       @default(0)
  issuedAt          DateTime  @default(now())
  returnedAt        DateTime?
  notes             String?
  
  consumable        StoreConsumable @relation(fields: [consumableId], references: [id])
  surgery           Surgery?        @relation(fields: [surgeryId], references: [id])
  
  @@map("consumable_consumptions")
}

model Equipment {
  id                  String              @id @default(uuid())
  name                String
  category            String
  serialNumber        String?             @unique
  manufacturer        String?
  vendor              String?
  assignedTheatreId   String?
  status              EquipmentStatus     @default(OPERATIONAL)
  maintenanceInterval MaintenanceInterval @default(AS_NEEDED)
  lastServiceDate     DateTime?
  nextServiceDue      DateTime?
  warrantyExpiry      DateTime?
  installationDate    DateTime?
  responsibleStaff    String?
  contactNumber       String?
  contactEmail        String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  // Relations
  assignedTheatre     TheatreSuite?       @relation(fields: [assignedTheatreId], references: [id])
  maintenanceRecords  EquipmentMaintenance[]
  faultReports        FaultReport[]
  dailyStatusLogs     DailyEquipmentStatus[]
  equipmentChecks     EquipmentCheckLog[]
  
  @@map("equipment")
}

model EquipmentMaintenance {
  id                String            @id @default(uuid())
  equipmentId       String
  scheduledDate     DateTime
  completedDate     DateTime?
  performedBy       String?
  status            MaintenanceStatus @default(SCHEDULED)
  maintenanceType   String            // "Routine", "Repair", "Calibration"
  findings          String?
  actionsTaken      String?
  nextServiceDate   DateTime?
  cost              Decimal?          @db.Decimal(10, 2)
  letterGenerated   Boolean           @default(false)
  letterSentDate    DateTime?
  acknowledgedBy    String?
  acknowledgedAt    DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  equipment         Equipment         @relation(fields: [equipmentId], references: [id])
  
  @@map("equipment_maintenance")
}

model DailyEquipmentStatus {
  id                String            @id @default(uuid())
  equipmentId       String
  logDate           DateTime          @default(now())
  status            EquipmentStatus
  reportedBy        String
  comments          String?
  faultReported     Boolean           @default(false)
  
  equipment         Equipment         @relation(fields: [equipmentId], references: [id])
  
  @@map("daily_equipment_status")
}

model FaultReport {
  id                String        @id @default(uuid())
  equipmentId       String?
  reportedBy        String
  faultType         String        // "Equipment", "Consumable", "Environmental", "Safety"
  description       String
  priority          FaultPriority @default(MEDIUM)
  status            FaultStatus   @default(REPORTED)
  acknowledgedBy    String?
  acknowledgedAt    DateTime?
  resolvedBy        String?
  resolvedAt        DateTime?
  resolution        String?
  closedBy          String?
  closedAt          DateTime?
  alertsSent        Int           @default(0)
  lastAlertSent     DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  equipment         Equipment?    @relation(fields: [equipmentId], references: [id])
  
  @@map("fault_reports")
}

model PatientMovement {
  id                String                @id @default(uuid())
  surgeryId         String
  phase             PatientMovementPhase
  timestamp         DateTime              @default(now())
  recordedBy        String?
  notes             String?
  
  surgery           Surgery               @relation(fields: [surgeryId], references: [id])
  
  @@map("patient_movements")
}

model UserReport {
  id                String        @id @default(uuid())
  reportedBy        String
  reportType        String        // "Challenge", "Suggestion", "Bottleneck", "Safety Concern"
  title             String
  description       String
  category          String?       // "Operational", "Equipment", "Workflow", "Safety"
  status            String        @default("Open") // "Open", "Under Review", "Resolved", "Closed"
  priority          String?
  assignedTo        String?
  resolution        String?
  resolvedAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@map("user_reports")
}

model SystemNotification {
  id                String            @id @default(uuid())
  userId            String?           // null = broadcast to all
  type              NotificationType
  title             String
  message           String
  priority          String            @default("NORMAL") // "NORMAL", "HIGH", "URGENT"
  isRead            Boolean           @default(false)
  actionUrl         String?
  relatedEntityType String?           // "Equipment", "Surgery", "Fault", etc.
  relatedEntityId   String?
  // Timeline tracking fields
  scheduledAt       DateTime?         // When event is scheduled (surgery time, maintenance due, etc.)
  deadlineAt        DateTime?         // Deadline for action (approval, expiry)
  reminderSentAt    DateTime?         // Track when reminder was sent
  isTimelineCritical Boolean          @default(false) // Flag for approaching deadlines
  createdAt         DateTime          @default(now())
  readAt            DateTime?
  
  @@index([userId, isRead])
  @@index([type])
  @@index([scheduledAt])
  @@index([deadlineAt])
  @@index([createdAt])
  @@map("system_notifications")
}

model PushSubscription {
  id              String    @id @default(uuid())
  userId          String
  endpoint        String    @unique
  p256dh          String    // Browser push key
  auth            String    // Browser push auth
  userAgent       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@map("push_subscriptions")
}

model PreoperativeSafetyCheck {
  id                    String    @id @default(uuid())
  surgeryId             String    @unique
  whoChecklistComplete  Boolean   @default(false)
  dvtRiskAssessed       Boolean   @default(false)
  bleedingRiskAssessed  Boolean   @default(false)
  medicationCleared     Boolean   @default(false)
  depositConfirmed      Boolean   @default(false)
  allChecksComplete     Boolean   @default(false)
  completedBy           String?
  completedAt           DateTime?
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  surgery               Surgery   @relation(fields: [surgeryId], references: [id])
  
  @@map("preoperative_safety_checks")
}

// ==================== PRE-OPERATIVE HOLDING AREA MODULE ====================

model HoldingAreaAssessment {
  id                        String              @id @default(uuid())
  surgeryId                 String              @unique
  patientId                 String
  
  // Reception Checklist Integration
  arrivalTime               DateTime            @default(now())
  receivedBy                String              // Holding area nurse ID
  status                    HoldingAreaStatus   @default(ARRIVED)
  
  // RECEPTION CHECKLIST - PHASE 1: IDENTIFICATION
  patientIdentityConfirmed  Boolean             @default(false)
  patientStatedName         Boolean             @default(false)      // Patient states his/her name
  crossCheckWithWristBand   Boolean             @default(false)      // Cross check with patient wrist band
  compareWithFolderName     Boolean             @default(false)      // Compare with the name on patient's folder
  compareWithOperationList  Boolean             @default(false)      // Compare with name on the operation list
  compareWithWardSlip       Boolean             @default(false)      // Compare with name on the ward slip
  identityVerificationMethod String?            // "ID Band", "Photo ID", "Verbal", "Family Confirmation"
  identityNotes             String?
  receptionRemarks          String?
  
  // RECEPTION CHECKLIST - PHASE 2: VERIFICATION OF PATIENTS
  consentFormComplete       Boolean             @default(false)
  surgeryFeePaidRecorded    Boolean             @default(false)
  receiptSighted            Boolean             @default(false)
  nilPerOralMaintained      Boolean             @default(false)
  operationSiteMarked       Boolean             @default(false)
  operationSiteShaved       Boolean             @default(false)      // If applicable
  patientDressedInGown      Boolean             @default(false)      // Including cap
  pantiesOrBoxersRemoved    Boolean             @default(false)      // Tights and bracelets over removed
  jewelriesRemoved          Boolean             @default(false)      // Including rings removed
  dentureNailPlatesRemoved  Boolean             @default(false)
  glassesContactLensRemoved Boolean             @default(false)
  makeUpNailPolishRemoved   Boolean             @default(false)      // Including nail polish removed
  capOrCrownRemoved         Boolean             @default(false)      // Capped/crowned/loose teeth
  investigationResultsAttached Boolean           @default(false)      // If applicable
  unitsOfBloodAvailable     Boolean             @default(false)      // If requested
  allNotesDrugsChartsAttached Boolean            @default(false)      // All notes, drugs and fluid charts attached
  prescriptionsAttachedToFolder Boolean          @default(false)      // All prescriptions given if prescribed
  routineVitalSignsChecked  Boolean             @default(false)      // Routine vital signs checked and recorded
  verificationRemarks       String?
  
  // Preoperative Nursing Visit Integration - BIODATA
  maritalStatus             String?
  
  // Preoperative - CO-MORBID CONDITIONS
  patientOnMedication       Boolean             @default(false)
  onMedicationForComorbid   Boolean             @default(false)
  comorbidConditionsList    String?             // List of conditions
  needToDiscontinueMeds     Boolean             @default(false)
  medsToDiscontinue         String?             // Which medications
  
  // Preoperative - PHYSICAL EXAMINATION
  headToToeAssessmentSatisfactory Boolean       @default(false)
  specificConcern           String?
  pulseRate                 Int?
  respiratoryRate           Int?                // per minute
  bloodPressure             String?             // e.g., "120/80"
  bloodPressureSystolic     Int?                // mmHg
  bloodPressureDiastolic    Int?                // mmHg
  spo2                      Int?                // oxygen saturation percentage
  weight                    Decimal?            @db.Decimal(5, 2)   // in kg
  height                    Decimal?            @db.Decimal(5, 2)   // in cm
  gcs                       Int?                // Glasgow Coma Scale
  temperature               Decimal?            @db.Decimal(4, 1)   // Celsius
  canSupportRespiration     Boolean             @default(true)
  useOfAssistiveDevices     Boolean             @default(false)
  assistiveDeviceType       String?             // Prosthesis type
  
  // Preoperative - PSYCHOLOGICAL STATUS ASSESSMENT
  psychologicalStatus       String?             // "Stable" or "Unstable"
  
  // Preoperative - INFORMED CONSENT
  understandingOfProcedure  Boolean             @default(false)
  consentFormSigned         Boolean             @default(false)
  consentWitnessed          Boolean             @default(false)
  consentNotSigned          Boolean             @default(false)
  consentRemarks            String?
  
  // Preoperative - SURGERY REQUIREMENTS
  requiresCatheterizingBag  Boolean             @default(false)
  requiresAnestheticDrugs   Boolean             @default(false)
  requiresBlood             Boolean             @default(false)
  requiresOtherSpecify      String?
  
  // Preoperative - OPERATION FEE
  operationFeePaid          Boolean             @default(false)
  operationFeeNotYetPaid    Boolean             @default(false)
  
  // Preoperative - PRE-ANAESTHESIA REVIEW
  patientReviewed           Boolean             @default(false)
  patientNotYetReviewed     Boolean             @default(false)
  patientNotForReview       Boolean             @default(false)
  typeOfAnesthesia          String?
  
  // Preoperative - LABORATORY INVESTIGATIONS
  labInvestigationsCarriedOut Boolean           @default(false)
  labResultsAvailable       Boolean             @default(false)
  labResultsAbnormality     String?             // Any abnormality
  
  // Preoperative - PRE-OPERATIVE TEACHING
  preOpTeachingGiven        Boolean             @default(false)
  watchPerOralMaintained    Boolean             @default(false)
  
  // Preoperative - GENERAL IMPRESSION
  patientReadyForSurgery    Boolean             @default(false)
  readinessRemarks          String?
  
  // Preoperative - PERIOPERATIVE NURSE(S) DETAILS
  perioperativeNurse1       String?             // Name
  perioperativeNurse1Designation String?
  perioperativeNurse2       String?             // Name
  perioperativeNurse2Designation String?
  dateOfPreVisit            DateTime?
  timeOfPreVisit            String?
  
  // Surgical Site & Procedure Verification
  surgicalSiteMarked        Boolean             @default(false)
  surgicalSiteConfirmed     Boolean             @default(false)
  procedureConfirmed        Boolean             @default(false)
  lateralityConfirmed       Boolean?            // For left/right procedures
  siteVerificationNotes     String?
  
  // Consent Validation
  consentFormPresent        Boolean             @default(false)
  consentUnderstandingConfirmed Boolean         @default(false)
  consentNotes              String?
  
  // Allergy Status
  allergyStatusChecked      Boolean             @default(false)
  hasAllergies              Boolean             @default(false)
  allergyDetails            String?             // JSON or text with allergy list
  allergyBandPresent        Boolean?
  
  // Fasting Status
  fastingStatusChecked      Boolean             @default(false)
  fastingCompliant          Boolean             @default(false)
  lastOralIntakeTime        DateTime?
  lastOralIntakeType        String?             // "Solid food", "Clear fluids", "Medication"
  fastingNotes              String?
  
  // Vital Signs
  heartRate                 Int?                // bpm
  oxygenSaturation          Int?                // percentage
  bloodGlucose              Decimal?            @db.Decimal(5, 2) // mmol/L
  vitalSignsNormal          Boolean             @default(true)
  vitalSignsConcerns        String?
  
  // Documentation Completeness
  preOpAssessmentPresent    Boolean             @default(false)
  labResultsPresent         Boolean             @default(false)
  imagingPresent            Boolean?
  ecgPresent                Boolean?
  crossMatchPresent         Boolean?
  anesthesiaAssessmentPresent Boolean           @default(false)
  medicationChartPresent    Boolean             @default(false)
  allDocumentationComplete  Boolean             @default(false)
  missingDocumentation      String?             // List of missing items
  
  // Pre-medications & IV Access
  preMedicationGiven        Boolean             @default(false)
  preMedicationDetails      String?
  ivAccessEstablished       Boolean             @default(false)
  ivSiteLocation            String?
  
  // Red Alert Management
  discrepancyDetected       Boolean             @default(false)
  redAlertTriggered         Boolean             @default(false)
  redAlertType              RedAlertType?
  redAlertDescription       String?
  redAlertTime              DateTime?
  redAlertResolvedBy        String?
  redAlertResolvedAt        DateTime?
  redAlertResolution        String?
  
  // Transfer Authorization
  clearedForTheatre         Boolean             @default(false)
  clearanceTime             DateTime?
  clearanceNotes            String?
  transferredToTheatre      Boolean             @default(false)
  transferTime              DateTime?
  handoverNurse             String?             // Theatre nurse receiving patient
  
  // Audit Trail
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  
  // Relations
  surgery                   Surgery             @relation(fields: [surgeryId], references: [id])
  patient                   Patient             @relation(fields: [patientId], references: [id])
  redAlerts                 HoldingAreaRedAlert[]
  
  @@map("holding_area_assessments")
}

model HoldingAreaRedAlert {
  id                    String                  @id @default(uuid())
  assessmentId          String
  alertType             RedAlertType
  severity              String                  @default("HIGH") // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  description           String
  triggeredBy           String                  // Nurse who triggered alert
  triggeredAt           DateTime                @default(now())
  
  // Notifications Sent
  surgeonNotified       Boolean                 @default(false)
  anesthetistNotified   Boolean                 @default(false)
  coordinatorNotified   Boolean                 @default(false)
  notificationsSentAt   DateTime?
  
  // Resolution
  acknowledged          Boolean                 @default(false)
  acknowledgedBy        String?
  acknowledgedAt        DateTime?
  resolved              Boolean                 @default(false)
  resolvedBy            String?
  resolvedAt            DateTime?
  resolutionAction      String?
  resolutionNotes       String?
  
  // Relations
  assessment            HoldingAreaAssessment   @relation(fields: [assessmentId], references: [id])
  
  @@map("holding_area_red_alerts")
}

// ==================== INTRA-OPERATIVE DOCUMENTATION ====================

model IntraOperativeRecord {
  id                        String      @id @default(uuid())
  surgeryId                 String      @unique
  
  // Theatre Entry
  theatreEntryTime          DateTime?
  patientPositioning        String?     // "Supine", "Prone", "Lateral", "Lithotomy"
  timeOut                   DateTime?   // Surgical timeout performed
  timeOutConfirmedBy        String?
  
  // Anesthesia Documentation
  anesthesiaStart           DateTime?
  anesthesiaType            AnesthesiaType?
  anesthetistId             String?
  nurseAnesthetistId        String?
  anesthesiaNotes           String?
  
  // Surgical Team
  primarySurgeonId          String?
  assistantSurgeonIds       String?     // JSON array of IDs
  scrubNurseId              String?
  circulatingNurseId        String?
  
  // Surgical Events
  knifeToSkinTime           DateTime?   // Incision time
  procedureStartTime        DateTime?
  procedureEndTime          DateTime?
  closureStartTime          DateTime?
  closureEndTime            DateTime?
  
  // Intraoperative Events Log
  eventsLog                 String?     // JSON array of timestamped events
  complicationsOccurred     Boolean     @default(false)
  complicationDetails       String?
  
  // Specimens & Pathology
  specimensSent             Boolean     @default(false)
  specimenDetails           String?     // JSON or text
  
  // Medications & Fluids
  medicationsAdministered   String?     // JSON array
  fluidsAdministered        String?     // JSON array with volumes
  bloodProductsGiven        Boolean     @default(false)
  bloodProductDetails       String?
  
  // Surgical Count
  instrumentCountCorrect    Boolean?
  swabCountCorrect          Boolean?
  needleCountCorrect        Boolean?
  countDiscrepancy          String?
  
  // Drains & Devices
  drainsInserted            Boolean     @default(false)
  drainDetails              String?     // Types and locations
  catheterInserted          Boolean     @default(false)
  catheterType              String?
  
  // Estimated Blood Loss
  estimatedBloodLoss        Int?        // in mL
  urineOutput               Int?        // in mL
  
  // Transfer to Recovery
  transferToPACUTime        DateTime?
  handoverToRecoveryNurse   String?
  
  // Audit
  createdBy                 String
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  
  // Relations
  surgery                   Surgery     @relation(fields: [surgeryId], references: [id])
  anesthesiaRecord          AnesthesiaMonitoringRecord?
  
  @@map("intraoperative_records")
}

// ==================== WHO INTRAOPERATIVE ANAESTHESIA MONITORING ====================

model AnesthesiaMonitoringRecord {
  id                        String      @id @default(uuid())
  intraOperativeRecordId    String      @unique
  surgeryId                 String      @unique
  patientId                 String
  
  // Pre-Anesthesia Assessment
  preOpDiagnosis            String?
  proposedProcedure         String?
  asaClassification         String?     // "I", "II", "III", "IV", "V", "E"
  weightKg                  Decimal?    @db.Decimal(5, 2)
  heightCm                  Decimal?    @db.Decimal(5, 2)
  bmi                       Decimal?    @db.Decimal(4, 1)
  
  // Anesthesia Type & Technique
  anesthesiaType            AnesthesiaType
  anesthesiaTechnique       String?     // "Spinal", "Epidural", "General-ETT", "General-LMA", "Combined"
  
  // SPINAL/EPIDURAL SPECIFIC
  spinalLevel               String?     // e.g., "L3-L4", "L4-L5"
  spinalNeedleSize          String?     // e.g., "25G", "27G"
  localAnestheticUsed       String?     // e.g., "Bupivacaine 0.5% Heavy"
  localAnestheticDose       String?     // e.g., "15mg (3ml)"
  additives                 String?     // e.g., "Fentanyl 25mcg"
  spinalAttempts            Int?
  spinalSuccessful          Boolean?
  highestSensoryLevel       String?     // e.g., "T6", "T8"
  motorBlock                String?     // "Bromage 0-3"
  
  // GENERAL ANESTHESIA SPECIFIC
  inductionAgents           String?     // JSON array: [{"drug": "Propofol", "dose": "2mg/kg", "time": "10:30"}]
  inductionTime             DateTime?
  intubationMethod          String?     // "ETT", "LMA", "Mask"
  ettSize                   String?     // e.g., "7.5mm"
  ettCuffPressure           Int?        // cmH2O
  intubationAttempts        Int?
  intubationDifficulty      String?     // "Easy", "Moderate", "Difficult"
  airwayGrade               String?     // Cormack-Lehane: "I", "II", "III", "IV"
  maintenanceAgents         String?     // JSON array of volatile/IV agents
  ventilationMode           String?     // "Spontaneous", "Controlled", "Assisted"
  tidalVolume               Int?        // mL
  respiratoryRate           Int?        // per minute
  peep                      Int?        // cmH2O
  fio2                      Int?        // percentage
  
  // Monitoring Equipment
  ecgMonitored              Boolean     @default(true)
  nibpMonitored             Boolean     @default(true)
  spo2Monitored             Boolean     @default(true)
  etco2Monitored            Boolean     @default(false)
  temperatureMonitored      Boolean     @default(false)
  cvpMonitored              Boolean     @default(false)
  arterialLineInserted      Boolean     @default(false)
  arterialLineSite          String?
  centralLineInserted       Boolean     @default(false)
  centralLineSite           String?
  urinaryCatheterInserted   Boolean     @default(false)
  nasogastricTubeInserted   Boolean     @default(false)
  
  // Baseline Vital Signs
  baselineHR                Int?
  baselineBP                String?     // "120/80"
  baselineSpo2              Int?
  baselineTemp              Decimal?    @db.Decimal(4, 1)
  baselineRR                Int?
  
  // Fluid Management
  ivAccessSites             String?     // JSON array
  crystalloidsGiven         Int?        // Total mL
  colloidsGiven             Int?        // Total mL
  bloodProductsGiven        String?     // JSON: [{"type": "PRBC", "units": 2}]
  totalFluidInput           Int?        // mL
  urineOutput               Int?        // mL
  estimatedBloodLoss        Int?        // mL
  fluidBalance              Int?        // mL (calculated)
  
  // Medications & Drugs Administered
  antibioticProphylaxis     String?     // Drug name and time
  muscleRelaxants           String?     // JSON array
  analgesics                String?     // JSON array
  vasoactiveDrugs           String?     // JSON array
  otherMedications          String?     // JSON array
  
  // Anesthesia Events & Complications
  hypotensionOccurred       Boolean     @default(false)
  hypotensionManagement     String?
  hypertensionOccurred      Boolean     @default(false)
  hypertensionManagement    String?
  bradycardiaOccurred       Boolean     @default(false)
  bradycardiaManagement     String?
  tachycardiaOccurred       Boolean     @default(false)
  tachycardiaManagement     String?
  desaturationOccurred      Boolean     @default(false)
  desaturationManagement    String?
  difficultAirway           Boolean     @default(false)
  difficultAirwayDetails    String?
  anaphylaxis               Boolean     @default(false)
  anaphylaxisManagement     String?
  otherComplications        String?     // JSON array
  
  // Emergence & Recovery
  anesthesiaEndTime         DateTime?
  emergenceAgents           String?     // Reversal agents
  extubationTime            DateTime?
  extubationCondition       String?     // "Awake", "Deep", "Failed"
  postOpVentilation         Boolean     @default(false)
  transferToPACU            Boolean     @default(true)
  transferToICU             Boolean     @default(false)
  
  // Post-Anesthesia Notes
  anesthesiaDuration        Int?        // minutes (calculated)
  surgicalDuration          Int?        // minutes (calculated)
  anesthetistNotes          String?
  complications             String?
  postOpOrders              String?
  
  // Signatures & Verification
  anesthetistName           String?
  anesthetistSignature      String?
  nurseAnesthetistName      String?
  recordCompletedAt         DateTime?
  
  // Audit Trail
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  
  // Relations
  intraOperativeRecord      IntraOperativeRecord  @relation(fields: [intraOperativeRecordId], references: [id])
  surgery                   Surgery               @relation(fields: [surgeryId], references: [id])
  patient                   Patient               @relation(fields: [patientId], references: [id])
  vitalSignsRecords         AnesthesiaVitalSigns[]
  medicationRecords         AnesthesiaMedicationRecord[]
  
  @@map("anesthesia_monitoring_records")
}

model AnesthesiaVitalSigns {
  id                        String      @id @default(uuid())
  anesthesiaRecordId        String
  
  // Time Recording
  recordedAt                DateTime    @default(now())
  minutesFromStart          Int?        // Auto-calculated from anesthesia start
  eventPhase                String?     // "INDUCTION", "MAINTENANCE", "EMERGENCE"
  
  // Cardiovascular
  heartRate                 Int?        // bpm
  systolicBP                Int?        // mmHg
  diastolicBP               Int?        // mmHg
  meanArterialPressure      Int?        // mmHg (calculated or measured)
  
  // Respiratory
  respiratoryRate           Int?        // per minute
  spo2                      Int?        // percentage
  etco2                     Int?        // mmHg
  peakAirwayPressure        Int?        // cmH2O
  tidalVolume               Int?        // mL
  minuteVolume              Decimal?    @db.Decimal(5, 2) // L/min
  
  // Temperature
  temperature               Decimal?    @db.Decimal(4, 1) // Celsius
  
  // Depth of Anesthesia
  bisValue                  Int?        // Bispectral Index (0-100)
  macValue                  Decimal?    @db.Decimal(3, 1) // Minimum Alveolar Concentration
  
  // Other Parameters
  cvp                       Int?        // cmH2O
  urineOutput               Int?        // mL (cumulative or interval)
  
  // Interventions at this time
  interventions             String?     // JSON: drugs given, ventilator changes, etc.
  
  // Notes
  notes                     String?
  alertTriggered            Boolean     @default(false)
  alertType                 String?     // "HYPOTENSION", "DESATURATION", etc.
  
  // Relations
  anesthesiaRecord          AnesthesiaMonitoringRecord @relation(fields: [anesthesiaRecordId], references: [id])
  
  @@map("anesthesia_vital_signs")
  @@index([anesthesiaRecordId, recordedAt])
}

// Medication Administration During Anesthesia
model AnesthesiaMedicationRecord {
  id                        String      @id @default(uuid())
  anesthesiaRecordId        String
  
  // Administration Time
  administeredAt            DateTime    @default(now())
  minutesFromStart          Int?        // Auto-calculated from anesthesia start
  eventPhase                String?     // "INDUCTION", "MAINTENANCE", "EMERGENCE"
  
  // Medication Type
  medicationType            String      // "ANESTHETIC", "ANALGESIC", "MUSCLE_RELAXANT", "ANTIBIOTIC", "VASOACTIVE", "IV_FLUID", "BLOOD_PRODUCT", "OTHER"
  
  // Medication Details
  medicationName            String      // e.g., "Propofol", "Fentanyl", "Normal Saline", "PRBC"
  dosage                    String?     // e.g., "2mg/kg", "100mcg", "500ml"
  concentration             String?     // e.g., "1%", "50mcg/ml"
  route                     String      // "IV", "IM", "INHALATION", "EPIDURAL", "SPINAL", "ORAL"
  site                      String?     // IV site or injection location
  
  // IV Fluid Specific
  fluidType                 String?     // "CRYSTALLOID", "COLLOID"
  volumeML                  Int?        // Total volume
  rateMLPerHour             Int?        // Infusion rate
  
  // Blood Product Specific
  bloodProductType          String?     // "PRBC", "FFP", "PLATELETS", "CRYOPRECIPITATE", "WHOLE_BLOOD"
  bloodUnits                Decimal?    @db.Decimal(3, 1)
  bloodBatchNumber          String?
  bloodGroupRh              String?     // "A+", "O-", etc.
  transfusionStartTime      DateTime?
  transfusionEndTime        DateTime?
  transfusionRateMLPerHour  Int?
  crossMatchDone            Boolean?
  transfusionReaction       Boolean     @default(false)
  transfusionReactionType   String?
  
  // Continuous Infusion
  isContinuousInfusion      Boolean     @default(false)
  infusionStartTime         DateTime?
  infusionEndTime           DateTime?
  totalVolumeInfused        Int?        // mL
  
  // Reason & Response
  indication                String?     // Why drug was given
  response                  String?     // Patient response
  adverseEffect             Boolean     @default(false)
  adverseEffectDescription  String?
  
  // Administration Details
  administeredBy            String?     // Name of person who administered
  verifiedBy                String?     // Name of person who verified
  notes                     String?
  
  // Audit
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  
  // Relations
  anesthesiaRecord          AnesthesiaMonitoringRecord @relation(fields: [anesthesiaRecordId], references: [id])
  
  @@map("anesthesia_medication_records")
  @@index([anesthesiaRecordId, administeredAt])
}

// ==================== POST-OPERATIVE RECOVERY (PACU) MODULE ====================

model PACUAssessment {
  id                        String                  @id @default(uuid())
  surgeryId                 String                  @unique
  patientId                 String
  
  // PACU Entry
  admissionTime             DateTime                @default(now())
  receivedBy                String                  // Recovery room nurse ID
  handoverFrom              String?                 // Theatre nurse/anesthetist
  
  // Initial Assessment (on arrival)
  consciousnessLevel        ConsciousnessLevel
  airwayStatus              AirwayStatus
  breathingPattern          String?                 // "Spontaneous", "Assisted", "Ventilated"
  oxygenTherapy             Boolean                 @default(false)
  oxygenFlowRate            Decimal?                @db.Decimal(4, 1) // L/min
  
  // Cardiovascular Status
  heartRateOnAdmission      Int?
  bloodPressureOnAdmission  String?                 // "120/80"
  peripheralPerfusion       String?                 // "Good", "Poor", "Mottled"
  capillaryRefillTime       String?                 // "<2 seconds", ">2 seconds"
  
  // Pain Assessment
  painScoreOnAdmission      Int?                    // 0-10 scale
  painLocation              String?
  painManagedAdequately     Boolean                 @default(false)
  
  // Surgical Site
  surgicalSiteCondition     String?                 // "Clean and dry", "Oozing", "Bleeding"
  dressingIntact            Boolean                 @default(true)
  drainsPresent             Boolean                 @default(false)
  drainType                 String?
  drainOutput               String?                 // "Minimal", "Moderate", "Heavy"
  
  // Fluid Balance
  ivFluidsRunning           Boolean                 @default(false)
  fluidType                 String?
  fluidRate                 String?
  urineOutput               Int?                    // mL
  catheterInSitu            Boolean                 @default(false)
  
  // Temperature
  temperatureOnAdmission    Decimal?                @db.Decimal(4, 1)
  normothermic              Boolean                 @default(true)
  warmingMeasures           String?
  
  // Nausea & Vomiting
  nauseaPresent             Boolean                 @default(false)
  vomitingOccurred          Boolean                 @default(false)
  antiemeticsGiven          Boolean                 @default(false)
  
  // Complications & Red Alerts
  complicationsDetected     Boolean                 @default(false)
  complicationDetails       String?
  redAlertTriggered         Boolean                 @default(false)
  redAlertType              RedAlertType?
  redAlertDescription       String?
  redAlertTime              DateTime?
  redAlertResolvedBy        String?
  redAlertResolvedAt        DateTime?
  
  // Discharge Readiness
  dischargeReadiness        PACUDischargeReadiness  @default(NOT_READY)
  dischargeTime             DateTime?
  dischargedTo              String?                 // Ward/ICU name
  dischargeVitalsStable     Boolean                 @default(false)
  dischargePainControlled   Boolean                 @default(false)
  dischargeFullyConscious   Boolean                 @default(false)
  dischargeNauseaFree       Boolean                 @default(false)
  
  // Final Assessment
  medicationsGivenInPACU    String?                 // JSON array
  totalTimeInPACU           Int?                    // Minutes
  dischargeNotes            String?
  warningSignsExplained     Boolean                 @default(false)
  wardNurseHandover         String?                 // Nurse receiving patient on ward
  
  // Audit Trail
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  
  // Relations
  surgery                   Surgery                 @relation(fields: [surgeryId], references: [id])
  patient                   Patient                 @relation(fields: [patientId], references: [id])
  vitalSigns                PACUVitalSigns[]
  redAlerts                 PACURedAlert[]
  
  @@map("pacu_assessments")
}

model PACUVitalSigns {
  id                    String          @id @default(uuid())
  pacuAssessmentId      String
  recordedAt            DateTime        @default(now())
  recordedBy            String          // Nurse ID
  
  // Vital Signs
  consciousnessLevel    ConsciousnessLevel?
  heartRate             Int?
  bloodPressure         String?         // "120/80"
  respiratoryRate       Int?
  oxygenSaturation      Int?            // SpO2 percentage
  temperature           Decimal?        @db.Decimal(4, 1)
  painScore             Int?            // 0-10
  
  // Clinical Notes
  notes                 String?
  interventionRequired  Boolean         @default(false)
  interventionDetails   String?
  
  // Relations
  pacuAssessment        PACUAssessment  @relation(fields: [pacuAssessmentId], references: [id])
  
  @@map("pacu_vital_signs")
}

model PACURedAlert {
  id                    String          @id @default(uuid())
  pacuAssessmentId      String
  alertType             RedAlertType
  severity              String          @default("HIGH")
  description           String
  triggeredBy           String
  triggeredAt           DateTime        @default(now())
  
  // Notifications
  surgeonNotified       Boolean         @default(false)
  anesthetistNotified   Boolean         @default(false)
  wardNotified          Boolean         @default(false)
  notificationsSentAt   DateTime?
  
  // Resolution
  acknowledged          Boolean         @default(false)
  acknowledgedBy        String?
  acknowledgedAt        DateTime?
  resolved              Boolean         @default(false)
  resolvedBy            String?
  resolvedAt            DateTime?
  resolutionAction      String?
  
  // Relations
  pacuAssessment        PACUAssessment  @relation(fields: [pacuAssessmentId], references: [id])
  
  @@map("pacu_red_alerts")
}

// ==================== SURGICAL COUNT CHECKLIST MODULE ====================

model SurgicalCountChecklist {
  id                        String      @id @default(uuid())
  surgeryId                 String      @unique
  
  // Theatre and Patient Details
  surgicalOperationType     String?     // Type of operation
  operationDate             DateTime?
  surgeonName               String?
  scrubNurseName            String?
  circulatingNurseName      String?
  
  // Pre-Surgery Count (Initial Count)
  // Instruments
  preCountInstruments       Int         @default(0)
  preCountInstrumentsRecorded Boolean   @default(false)
  
  // Swabs (categorized)
  preCountSmallSwabs        Int         @default(0)      // Swab small
  preCountMediumSwabs       Int         @default(0)      // Swab medium
  preCountLargeSwabs        Int         @default(0)      // Swab large
  preCountRollSwabs         Int         @default(0)      // Roll swabs
  preCountTapeLaparotomy    Int         @default(0)      // Tape laparotomy
  preCountAbdominalPack     Int         @default(0)      // Abdominal pack
  preCountSwabsRecorded     Boolean     @default(false)
  
  // Sharps
  preCountBlades            Int         @default(0)      // Blades
  preCountNeedles           Int         @default(0)      // Needles
  preCountSutures           Int         @default(0)      // Sutures
  preCountTrocars           Int         @default(0)      // Trocars
  preCountSharpsRecorded    Boolean     @default(false)
  
  // Others
  preCountOthers            String?                       // Other items
  
  // Added Count (Additional items during surgery)
  addedInstruments          Int         @default(0)
  addedSmallSwabs           Int         @default(0)
  addedMediumSwabs          Int         @default(0)
  addedLargeSwabs           Int         @default(0)
  addedRollSwabs            Int         @default(0)
  addedTapeLaparotomy       Int         @default(0)
  addedAbdominalPack        Int         @default(0)
  addedBlades               Int         @default(0)
  addedNeedles              Int         @default(0)
  addedSutures              Int         @default(0)
  addedTrocars              Int         @default(0)
  addedOthers               String?
  
  // First Count (Before closure)
  firstCountInstruments     Int         @default(0)
  firstCountSmallSwabs      Int         @default(0)
  firstCountMediumSwabs     Int         @default(0)
  firstCountLargeSwabs      Int         @default(0)
  firstCountRollSwabs       Int         @default(0)
  firstCountTapeLaparotomy  Int         @default(0)
  firstCountAbdominalPack   Int         @default(0)
  firstCountBlades          Int         @default(0)
  firstCountNeedles         Int         @default(0)
  firstCountSutures         Int         @default(0)
  firstCountTrocars         Int         @default(0)
  firstCountOthers          String?
  firstCountTime            DateTime?
  firstCountCorrect         Boolean?
  firstCountDiscrepancy     String?     // Description of any discrepancy
  
  // Second Count (After closure/final count)
  secondCountInstruments    Int         @default(0)
  secondCountSmallSwabs     Int         @default(0)
  secondCountMediumSwabs    Int         @default(0)
  secondCountLargeSwabs     Int         @default(0)
  secondCountRollSwabs      Int         @default(0)
  secondCountTapeLaparotomy Int         @default(0)
  secondCountAbdominalPack  Int         @default(0)
  secondCountBlades         Int         @default(0)
  secondCountNeedles        Int         @default(0)
  secondCountSutures        Int         @default(0)
  secondCountTrocars        Int         @default(0)
  secondCountOthers         String?
  secondCountTime           DateTime?
  secondCountCorrect        Boolean?
  secondCountDiscrepancy    String?     // Description of any discrepancy
  
  // Final Count Verification
  allCountsCorrect          Boolean     @default(false)
  finalCountVerifiedBy      String?     // Scrub nurse
  finalCountWitnessedBy     String?     // Circulating nurse
  surgeonNotifiedOfCount    Boolean     @default(false)
  
  // Discrepancy Management
  discrepancyOccurred       Boolean     @default(false)
  discrepancyType           String?     // "Missing item", "Extra item", "Count mismatch"
  discrepancyDetails        String?
  discrepancyResolved       Boolean     @default(false)
  discrepancyResolution     String?
  xRayOrdered               Boolean     @default(false)
  xRayResult                String?
  incidentReportFiled       Boolean     @default(false)
  
  // Count Documentation
  countSheetCompleted       Boolean     @default(false)
  signatureScrubNurse       String?
  signatureCirculatingNurse String?
  signatureSurgeon          String?
  
  // Remarks
  remarks                   String?
  specialNotes              String?
  
  // Audit Trail
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  completedAt               DateTime?
  
  // Relations
  surgery                   Surgery     @relation(fields: [surgeryId], references: [id])
  countEvents               SurgicalCountEvent[]
  
  @@map("surgical_count_checklists")
}

model SurgicalCountEvent {
  id                    String                    @id @default(uuid())
  countChecklistId      String
  eventType             String                    // "PRE_COUNT", "ADDED_ITEMS", "FIRST_COUNT", "SECOND_COUNT", "DISCREPANCY"
  itemType              String                    // "INSTRUMENTS", "SWABS", "SHARPS", "OTHERS"
  itemDescription       String?
  quantityAdded         Int?
  quantityRemoved       Int?
  recordedBy            String                    // Nurse ID/name
  recordedAt            DateTime                  @default(now())
  notes                 String?
  
  // Relations
  countChecklist        SurgicalCountChecklist    @relation(fields: [countChecklistId], references: [id])
  
  @@map("surgical_count_events")
}

// ============================================================================
// SURGICAL TIMING MODULE
// ============================================================================

enum SurgicalPhase {
  PATIENT_IN_ROOM
  ANESTHESIA_START
  ANESTHESIA_READY
  TIMEOUT_COMPLETED
  INCISION
  PROCEDURE_START
  PROCEDURE_END
  CLOSURE_START
  CLOSURE_END
  DRESSING_APPLIED
  PATIENT_EXTUBATED
  PATIENT_OUT_OF_ROOM
}

model SurgicalTiming {
  id                        String          @id @default(uuid())
  surgeryId                 String          @unique
  
  // Pre-Operative Times
  patientEnteredRoomTime    DateTime?       // Patient arrived in OR
  anesthesiaStartTime       DateTime?       // Anesthesia induction started
  anesthesiaReadyTime       DateTime?       // Patient ready for surgery
  
  // Timeout
  timeoutStartTime          DateTime?       // WHO timeout started
  timeoutCompletedTime      DateTime?       // WHO timeout completed
  timeoutPerformedBy        String?         // Staff who led timeout
  timeoutTeamPresent        String?         // JSON: Team members present
  
  // Surgical Times
  incisionTime              DateTime?       // Knife to skin (first incision)
  procedureStartTime        DateTime?       // Actual procedure start
  procedureEndTime          DateTime?       // Procedure completed
  closureStartTime          DateTime?       // Wound closure started
  closureEndTime            DateTime?       // Wound closure completed
  dressingAppliedTime       DateTime?       // Dressing applied
  
  // Post-Operative Times
  patientExtubatedTime      DateTime?       // Patient extubated (if applicable)
  patientLeftRoomTime       DateTime?       // Patient left OR
  
  // Sign Out
  signOutTime               DateTime?       // WHO sign out completed
  signOutPerformedBy        String?         // Staff who led sign out
  
  // Calculated Durations (in minutes)
  anesthesiaDuration        Int?            // anesthesiaReady - anesthesiaStart
  surgicalDuration          Int?            // procedureEnd - incisionTime
  totalORTime               Int?            // patientLeftRoom - patientEnteredRoom
  closureDuration           Int?            // closureEnd - closureStart
  turnoverTime              Int?            // Next patient in - previous patient out
  
  // Delays and Interruptions
  delayOccurred             Boolean         @default(false)
  delayReason               String?         // Reason for any delay
  delayDuration             Int?            // Minutes of delay
  interruptionOccurred      Boolean         @default(false)
  interruptionReason        String?
  interruptionDuration      Int?            // Minutes
  
  // Team Members Present
  surgeonPresent            String?         // JSON: Surgeon(s) details
  anesthetistPresent        String?         // JSON: Anesthetist details
  scrubNursePresent         String?         // JSON: Scrub nurse(s)
  circulatingNursePresent   String?         // JSON: Circulating nurse(s)
  otherTeamMembers          String?         // JSON: Other team members
  
  // Notes
  timingNotes               String?
  recordedBy                String          // User who recorded times
  
  // Audit
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  
  // Relations
  surgery                   Surgery         @relation(fields: [surgeryId], references: [id])
  events                    SurgicalEvent[]
  
  @@map("surgical_timings")
}

model SurgicalEvent {
  id                    String          @id @default(uuid())
  surgicalTimingId      String
  
  eventType             SurgicalPhase
  eventTime             DateTime
  recordedBy            String          // User ID
  notes                 String?
  
  // Auto-calculated
  minutesFromStart      Int?            // Minutes from patient entering room
  
  createdAt             DateTime        @default(now())
  
  // Relations
  surgicalTiming        SurgicalTiming  @relation(fields: [surgicalTimingId], references: [id])
  
  @@map("surgical_events")
}

// Staff Duty Tracking Models

enum DutyStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DutyType {
  THEATRE_CLEANING
  PATIENT_TRANSPORT
  WASHING_MACINTOSH
  EQUIPMENT_STERILIZATION
  LINEN_MANAGEMENT
  WASTE_DISPOSAL
  EQUIPMENT_SETUP
  OTHER
}

model TheatreCleaningLog {
  id                    String          @id @default(uuid())
  
  // Cleaner Info
  cleanerId             String
  cleanerCode           String          // Staff code assigned at profile creation
  cleanerName           String
  
  // Theatre Info
  theatreId             String
  theatreName           String
  
  // Timing
  startTime             DateTime        @default(now())
  endTime               DateTime?
  durationMinutes       Int?            // Calculated when completed
  
  // Status
  status                DutyStatus      @default(IN_PROGRESS)
  
  // Details
  cleaningType          String?         // e.g., "Post-Surgery", "Daily", "Deep Clean"
  notes                 String?
  
  // Quality Check
  verifiedBy            String?         // Staff who verified cleaning
  verifiedAt            DateTime?
  qualityRating         Int?            // 1-5 rating
  
  // Audit
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  cleaner               User            @relation(fields: [cleanerId], references: [id])
  theatre               TheatreSuite    @relation(fields: [theatreId], references: [id])
  
  @@map("theatre_cleaning_logs")
}

model PatientTransportLog {
  id                    String          @id @default(uuid())
  
  // Porter Info
  porterId              String
  porterCode            String          // Staff code assigned at profile creation
  porterName            String
  
  // Patient Info
  patientId             String?
  patientName           String
  patientFolderNumber   String
  
  // Surgery Info (optional - if related to surgery)
  surgeryId             String?
  
  // Transport Details
  fromLocation          String          // e.g., "Ward 5A", "Holding Area", "PACU"
  toLocation            String          // e.g., "Theatre 2", "ICU", "Ward 3B"
  transportType         String?         // e.g., "Pre-Op Transfer", "Post-Op Transfer", "Emergency"
  
  // Timing
  startTime             DateTime        @default(now())
  endTime               DateTime?
  durationMinutes       Int?            // Calculated when completed
  
  // Status
  status                DutyStatus      @default(IN_PROGRESS)
  
  // Details
  notes                 String?
  complications         String?         // Any issues during transport
  equipmentUsed         String?         // e.g., "Stretcher", "Wheelchair", "Bed"
  
  // Verification
  receivedBy            String?         // Staff who received patient
  receivedAt            DateTime?
  
  // Audit
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  porter                User            @relation(fields: [porterId], references: [id])
  patient               Patient?        @relation(fields: [patientId], references: [id])
  surgery               Surgery?        @relation(fields: [surgeryId], references: [id])
  
  @@map("patient_transport_logs")
}

model StaffDutyLog {
  id                    String          @id @default(uuid())
  
  // Staff Info
  staffId               String
  staffCode             String          // Staff code assigned at profile creation
  staffName             String
  staffRole             UserRole
  
  // Duty Details
  dutyType              DutyType
  dutyDescription       String?         // Custom description
  
  // Timing
  startTime             DateTime        @default(now())
  endTime               DateTime?
  durationMinutes       Int?            // Calculated when completed
  
  // Status
  status                DutyStatus      @default(IN_PROGRESS)
  
  // Location/Equipment
  location              String?         // Where duty was performed
  equipmentInvolved     String?         // JSON: Equipment used or cleaned
  
  // Details
  quantity              Int?            // e.g., number of items washed
  notes                 String?
  
  // Quality/Verification
  verifiedBy            String?
  verifiedAt            DateTime?
  qualityRating         Int?            // 1-5 rating
  
  // Audit
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  staff                 User            @relation(fields: [staffId], references: [id])
  
  @@map("staff_duty_logs")
}

// Anaesthetic Technician Setup Tracking

enum SetupStatus {
  NOT_STARTED
  IN_PROGRESS
  READY
  BLOCKED
}

enum EquipmentCondition {
  OPERATIONAL
  NEEDS_ATTENTION
  FAULTY
  NOT_AVAILABLE
}

model AnesthesiaSetupLog {
  id                    String              @id @default(uuid())
  
  // Technician Info
  technicianId          String
  technicianName        String
  technicianCode        String?
  
  // Theatre Info
  theatreId             String
  theatreName           String
  allocationId          String?             // Link to theatre allocation
  
  // Date
  setupDate             DateTime            @db.Date
  
  // Timing
  setupStartTime        DateTime            @default(now())
  setupEndTime          DateTime?
  readyTime             DateTime?           // When marked as ready
  durationMinutes       Int?
  
  // Status
  status                SetupStatus         @default(IN_PROGRESS)
  isReady               Boolean             @default(false)
  
  // Geolocation (Mandatory)
  latitude              Float
  longitude             Float
  locationName          String              // Reverse geocoded place name
  locationAddress       String?             // Full address
  
  // Readiness Checklist
  gasSupplyChecked      Boolean             @default(false)
  suctionChecked        Boolean             @default(false)
  monitorsChecked       Boolean             @default(false)
  ventilatorChecked     Boolean             @default(false)
  anesthesiaMachineChecked Boolean          @default(false)
  emergencyDrugsChecked Boolean             @default(false)
  airwayEquipmentChecked Boolean            @default(false)
  ivEquipmentChecked    Boolean             @default(false)
  
  // Notes
  setupNotes            String?
  blockingIssues        String?             // Issues preventing readiness
  
  // End of Day
  endOfDayLogged        Boolean             @default(false)
  endOfDayTime          DateTime?
  endOfDayNotes         String?
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  technician            User                @relation("TechnicianSetupLogs", fields: [technicianId], references: [id])
  theatre               TheatreSuite        @relation("TheatreSetupLogs", fields: [theatreId], references: [id])
  allocation            TheatreAllocation?  @relation("AllocationSetupLogs", fields: [allocationId], references: [id])
  equipmentChecks       EquipmentCheckLog[]
  
  @@map("anesthesia_setup_logs")
}

model EquipmentCheckLog {
  id                    String              @id @default(uuid())
  
  // Setup Log Reference
  setupLogId            String
  
  // Equipment Info
  equipmentId           String?             // Reference to Equipment model
  equipmentName         String
  equipmentType         String              // e.g., "Ventilator", "Monitor", "Suction"
  serialNumber          String?
  
  // Check Details
  checkTime             DateTime            @default(now())
  condition             EquipmentCondition
  isFunctional          Boolean
  
  // Malfunction Details
  malfunctionDescription String?
  malfunctionSeverity   String?             // LOW, MEDIUM, HIGH, CRITICAL
  requiresImmediateAttention Boolean        @default(false)
  
  // Alert Tracking
  alertSent             Boolean             @default(false)
  alertSentAt           DateTime?
  alertRecipients       String?             // JSON: List of users notified
  
  // Resolution
  issueResolved         Boolean             @default(false)
  resolvedAt            DateTime?
  resolvedBy            String?
  resolutionNotes       String?
  
  // Testing Details
  testParameters        String?             // JSON: Test results/parameters
  calibrationStatus     String?
  lastMaintenanceDate   DateTime?
  
  // Notes
  notes                 String?
  recommendations       String?
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  setupLog              AnesthesiaSetupLog  @relation(fields: [setupLogId], references: [id], onDelete: Cascade)
  equipment             Equipment?          @relation(fields: [equipmentId], references: [id])
  
  @@map("equipment_check_logs")
}

// Equipment Checkout/Check-in System for Anaesthetic Technicians
enum CheckoutStatus {
  CHECKED_OUT
  RETURNED
  OVERDUE
}

enum ItemCondition {
  FUNCTIONAL
  FAULTY
  NEEDS_MAINTENANCE
  DAMAGED
}

model EquipmentCheckout {
  id                    String              @id @default(uuid())
  
  // Store Keeper Info (who is logging the checkout)
  storeKeeperId         String
  storeKeeperName       String
  
  // Collector Info (nurse/technician collecting items)
  collectorName         String              // Name from hospital ID card
  collectorHospitalId   String              // Hospital ID number
  collectorRole         String              // SCRUB_NURSE or ANAESTHETIC_TECHNICIAN
  
  // Theatre & Shift Info
  theatreId             String              // Theatre assigned for shift
  shift                 DutyShift
  date                  DateTime
  
  // Checkout Details
  checkoutTime          DateTime            @default(now())
  checkoutNotes         String?
  
  // Return Details  
  returnTime            DateTime?
  returnNotes           String?
  returnedBy            String?             // Store keeper who processed return
  status                CheckoutStatus      @default(CHECKED_OUT)
  
  // Items
  items                 CheckoutItem[]
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  storeKeeper           User                @relation("StoreKeeperCheckouts", fields: [storeKeeperId], references: [id])
  faultyAlerts          EquipmentFaultAlert[]
  
  @@map("equipment_checkouts")
}

model CheckoutItem {
  id                    String              @id @default(uuid())
  checkoutId            String
  
  // Item Info
  inventoryItemId       String?
  itemName              String
  itemCategory          String              // MACHINE, DEVICE, etc.
  quantity              Int                 @default(1)
  serialNumber          String?
  
  // Checkout Condition
  checkoutCondition     ItemCondition       @default(FUNCTIONAL)
  checkoutRemarks       String?
  
  // Return Condition
  returnCondition       ItemCondition?
  returnRemarks         String?
  returnTime            DateTime?
  
  // Fault Reporting
  isFaulty              Boolean             @default(false)
  faultDescription      String?
  faultSeverity         String?             // LOW, MEDIUM, HIGH, CRITICAL
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  checkout              EquipmentCheckout   @relation(fields: [checkoutId], references: [id], onDelete: Cascade)
  inventoryItem         InventoryItem?      @relation("CheckoutItems", fields: [inventoryItemId], references: [id])
  
  @@map("checkout_items")
}

model EquipmentFaultAlert {
  id                    String              @id @default(uuid())
  checkoutId            String
  
  // Faulty Item Details
  itemName              String
  faultDescription      String
  severity              String              // LOW, MEDIUM, HIGH, CRITICAL
  reportedBy            String              // Technician name
  reportedById          String              // Technician user ID
  
  // Alert Info
  alertTime             DateTime            @default(now())
  theatreId             String
  shift                 DutyShift
  date                  DateTime
  
  // Status Tracking
  status                FaultStatus         @default(REPORTED)
  acknowledgedBy        String?
  acknowledgedAt        DateTime?
  resolvedBy            String?
  resolvedAt            DateTime?
  resolutionNotes       String?
  
  // Priority & Escalation
  priority              FaultPriority       @default(HIGH)
  requiresImmediateAction Boolean           @default(true)
  escalatedToChairman   Boolean             @default(false)
  
  // Notifications Sent
  managerNotified       Boolean             @default(false)
  chairmanNotified      Boolean             @default(false)
  notificationsSent     String?             // JSON: List of recipients and times
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  checkout              EquipmentCheckout   @relation(fields: [checkoutId], references: [id])
  reportedByUser        User                @relation("ReportedFaults", fields: [reportedById], references: [id])
  
  @@map("equipment_fault_alerts")
}

// ===== NEW ENHANCED MODULES =====

// Enums for Pre-Operative Assessment Module
enum PreOpReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  APPROVED
}

enum PrescriptionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  DISPENSED
  PACKED
  PARTIALLY_PACKED
  LATE_ARRIVAL
  COLLECTED            // Anaesthetist has collected medications from pharmacy
  IN_USE               // Medications are being used in surgery
  RECONCILED           // Post-surgery reconciliation complete
  RETURNED             // Unused medications returned to pharmacy
  QUERY_ISSUED         // Non-return query issued to anaesthetist
}

enum MedicationUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum BloodRequestStatus {
  REQUESTED
  ACKNOWLEDGED
  IN_PREPARATION
  READY
  DELIVERED
  CANCELLED
}

enum EmergencyAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  CANCELLED
}

enum EmergencyAlertPriority {
  CRITICAL
  HIGH
  MEDIUM
}

// Pre-Operative Anesthetic Review Model
model PreOperativeAnestheticReview {
  id                        String                @id @default(uuid())
  
  // Patient & Surgery Info
  surgeryId                 String                @unique
  patientId                 String
  patientName               String
  folderNumber              String
  
  // Anesthetist Info
  anesthetistId             String                // Resident/registrar conducting review
  anesthetistName           String
  consultantAnesthetistId   String?               // Consultant who will approve
  consultantName            String?
  
  // Review Details
  reviewDate                DateTime              @default(now())
  scheduledSurgeryDate      DateTime
  
  // Clinical Assessment
  currentMedications        String?               // JSON array
  allergies                 String?               // JSON array
  comorbidities             String?               // JSON array
  previousAnesthesia        String?
  lastOralIntake            DateTime?
  fastingStatus             String?
  
  // Physical Examination
  weight                    Float?
  height                    Float?
  bmi                       Float?
  bloodPressure             String?
  heartRate                 Int?
  respiratoryRate           Int?
  temperature               Float?
  
  // Airway Assessment
  airwayClass               String?               // Mallampati class
  neckMovement              String?
  dentition                 String?
  
  // Lab Results
  hemoglobin                Float?
  plateletCount             Int?
  ptInr                     Float?
  creatinine                Float?
  sodium                    Float?
  potassium                 Float?
  bloodGlucose              Float?
  otherLabResults           String?               // JSON
  
  // ASA Classification
  asaClass                  String?
  
  // Anesthetic Plan
  proposedAnesthesiaType    AnesthesiaType?
  anestheticPlan            String?               // Detailed plan
  specialConsiderations     String?
  
  // Risk Assessment
  riskLevel                 String?               // LOW, MODERATE, HIGH
  riskFactors               String?               // JSON array
  
  // Status
  status                    PreOpReviewStatus     @default(IN_PROGRESS)
  
  // Approval
  approvedAt                DateTime?
  approvedBy                String?
  approvalNotes             String?
  rejectionReason           String?
  
  // General Notes
  reviewNotes               String?
  recommendations           String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  surgery                   Surgery               @relation("PreOpReviews", fields: [surgeryId], references: [id])
  patient                   Patient               @relation("PatientPreOpReviews", fields: [patientId], references: [id])
  anesthetist               User                  @relation("AnesthetistReviews", fields: [anesthetistId], references: [id])
  consultantAnesthetist     User?                 @relation("ConsultantReviews", fields: [consultantAnesthetistId], references: [id])
  prescriptions             AnestheticPrescription[]
  
  @@map("preoperative_anesthetic_reviews")
}

// Anesthetic Prescription Model
model AnestheticPrescription {
  id                        String                @id @default(uuid())
  
  // Link to Pre-Op Review
  preOpReviewId             String
  surgeryId                 String
  patientId                 String
  patientName               String
  
  // Prescriber Info
  prescribedById            String                // Anesthetist who created prescription
  prescribedByName          String
  prescriptionDate          DateTime              @default(now())
  
  // Approval Info
  approvedById              String?               // Consultant anesthetist
  approvedByName            String?
  approvedAt                DateTime?
  rejectionReason           String?
  
  // Pharmacist Info
  packedById                String?               // Pharmacist who packed medications
  packedByName              String?
  packedAt                  DateTime?
  packingNotes              String?
  
  // Prescription Details
  medications               String                // JSON array of medications with doses, routes, timing
  fluids                    String?               // IV fluids
  emergencyDrugs            String?               // Emergency medications
  
  // Timing
  scheduledSurgeryDate      DateTime
  urgency                   MedicationUrgency     @default(ROUTINE)
  
  // Status
  status                    PrescriptionStatus    @default(DRAFT)
  
  // Special Instructions
  specialInstructions       String?
  allergyAlerts             String?               // Highlighted allergies
  
  // Late Arrival Tracking
  isLateArrival             Boolean               @default(false)
  lateArrivalFlaggedAt      DateTime?
  approvalDeadline          DateTime?             // Default: 6 PM day before surgery
  
  // Out-of-Stock Tracking
  outOfStockItems           String?               // JSON: items that are out of stock
  hasOutOfStockItems        Boolean               @default(false)
  outOfStockNotifiedAt      DateTime?
  
  // Individual medication packing status
  medicationPackingStatus   String?               // JSON: per-medication packed/not-packed/out-of-stock
  
  // Notes
  prescriptionNotes         String?
  pharmacistNotes           String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  preOpReview               PreOperativeAnestheticReview @relation(fields: [preOpReviewId], references: [id])
  surgery                   Surgery               @relation("SurgeryPrescriptions", fields: [surgeryId], references: [id])
  patient                   Patient               @relation("PatientPrescriptions", fields: [patientId], references: [id])
  prescribedBy              User                  @relation("PrescribedBy", fields: [prescribedById], references: [id])
  approvedBy                User?                 @relation("ApprovedBy", fields: [approvedById], references: [id])
  packedBy                  User?                 @relation("PackedBy", fields: [packedById], references: [id])
  prescriptionItems         PrescriptionMedicationItem[]
  
  // Medication Tracking Relations
  medicationCollections     MedicationCollection[]
  medicationUsageRecords    MedicationUsageRecord[]
  medicationReconciliation  MedicationReconciliation?
  medicationReturns         MedicationReturn[]
  additionalMedRequests     AdditionalMedicationRequest[]
  nonReturnQueries          MedicationNonReturnQuery[]
  
  @@map("anesthetic_prescriptions")
}

// Individual medication tracking within a prescription
model PrescriptionMedicationItem {
  id                        String                @id @default(uuid())
  prescriptionId            String
  
  // Drug Details
  drugName                  String
  dosage                    String
  route                     String                // IV, IM, PO, etc.
  frequency                 String?
  timing                    String?               // Pre-op, Intra-op, Post-op
  quantity                  Int                   @default(1)
  
  // Packing Status
  isPacked                  Boolean               @default(false)
  packedAt                  DateTime?
  isOutOfStock              Boolean               @default(false)
  outOfStockFlaggedAt       DateTime?
  substituteAvailable       Boolean               @default(false)
  substituteDrugName        String?
  
  // Notes
  pharmacistNote            String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  
  @@map("prescription_medication_items")
}

// Emergency Surgery Booking
model EmergencySurgeryBooking {
  id                        String                @id @default(uuid())
  
  // Patient Info
  patientName               String
  folderNumber              String
  age                       Int?
  gender                    String?
  ward                      String?
  diagnosis                 String
  
  // Surgery Details
  procedureName             String
  surgicalUnit              String
  indication                String                // Why emergency
  surgeonId                 String
  surgeonName               String
  anesthetistId             String?
  anesthetistName           String?
  
  // Timing
  requestedAt               DateTime              @default(now())
  requiredByTime            DateTime?             // When surgery must start
  estimatedDuration         Int?                  // Minutes
  
  // Theatre Assignment
  theatreId                 String?
  theatreName               String?
  
  // Priority & Classification
  priority                  EmergencyAlertPriority @default(CRITICAL)
  classification            String?               // Life-threatening, Limb-threatening, etc.
  
  // Requirements
  bloodRequired             Boolean               @default(false)
  bloodType                 String?
  bloodUnits                Int?
  specialEquipment          String?               // JSON array
  specialRequirements       String?
  
  // Booking Status
  status                    EmergencyBookingStatus @default(SUBMITTED)
  
  // Linked records (created after approval)
  surgeryId                 String?               @unique
  emergencyAlertId          String?
  
  // Approval
  approvedById              String?
  approvedByName            String?
  approvedAt                DateTime?
  rejectionReason           String?
  
  // Notifications sent
  alertsSentAt              DateTime?
  notifiedRoles             String?               // JSON array of roles notified
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  surgeon                   User                  @relation("EmergencyBookingSurgeon", fields: [surgeonId], references: [id])
  anesthetist               User?                 @relation("EmergencyBookingAnesthetist", fields: [anesthetistId], references: [id])
  surgery                   Surgery?              @relation("EmergencyBookingSurgery", fields: [surgeryId], references: [id])
  teamAvailability          EmergencyTeamAvailability[]
  preAnaestheticReviews     EmergencyPreAnaestheticReview[]
  emergencyPrescriptions    EmergencyPrescription[]
  
  @@map("emergency_surgery_bookings")
}

enum EmergencyBookingStatus {
  SUBMITTED
  APPROVED
  THEATRE_ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Blood Request and Alert Model
model BloodRequest {
  id                        String                @id @default(uuid())
  
  // Patient & Surgery Info
  surgeryId                 String
  patientId                 String
  patientName               String
  folderNumber              String
  
  // Blood Bank Details
  bloodType                 String                // A+, B-, O+, etc.
  rhFactor                  String                // Positive, Negative
  unitsRequested            Int
  bloodProducts             String                // JSON: Packed cells, FFP, Platelets, etc.
  
  // Requesting Info
  requestedById             String                // Surgeon or Anesthetist
  requestedByName           String
  requestedAt               DateTime              @default(now())
  
  // Surgery Details
  scheduledSurgeryDate      DateTime
  surgeryType               SurgeryType
  isEmergency               Boolean               @default(false)
  procedureName             String
  
  // Cross-match Info
  crossMatchRequired        Boolean               @default(true)
  crossMatchCompleted       Boolean               @default(false)
  crossMatchCompletedAt     DateTime?
  
  // Blood Bank Response
  acknowledgedById          String?               // Blood bank staff
  acknowledgedByName        String?
  acknowledgedAt            DateTime?
  
  preparedById              String?
  preparedByName            String?
  preparedAt                DateTime?
  
  readyAt                   DateTime?
  deliveredAt               DateTime?
  
  // Status
  status                    BloodRequestStatus    @default(REQUESTED)
  
  // Urgency & Priority
  urgency                   MedicationUrgency     @default(ROUTINE)
  priorityLevel             Int                   @default(3) // 1-5, 1 being highest
  
  // Notes
  clinicalIndication        String?
  specialRequirements       String?
  bloodBankNotes            String?
  
  // Cancellation
  cancelledAt               DateTime?
  cancellationReason        String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  surgery                   Surgery               @relation("SurgeryBloodRequests", fields: [surgeryId], references: [id])
  patient                   Patient               @relation("PatientBloodRequests", fields: [patientId], references: [id])
  requestedBy               User                  @relation("BloodRequestedBy", fields: [requestedById], references: [id])
  acknowledgedBy            User?                 @relation("BloodAcknowledgedBy", fields: [acknowledgedById], references: [id])
  preparedBy                User?                 @relation("BloodPreparedBy", fields: [preparedById], references: [id])
  
  @@map("blood_requests")
}

// Emergency Surgery Alert Model
model EmergencySurgeryAlert {
  id                        String                @id @default(uuid())
  
  // Surgery Info
  surgeryId                 String
  patientName               String
  folderNumber              String
  age                       Int?
  gender                    String?
  
  // Emergency Details
  procedureName             String
  surgicalUnit              String
  indication                String
  
  // Surgeon Info
  surgeonId                 String?
  surgeonName               String
  
  // Timing
  alertTriggeredAt          DateTime              @default(now())
  estimatedStartTime        DateTime?
  actualStartTime           DateTime?
  
  // Theatre Assignment
  theatreId                 String?
  theatreName               String?
  
  // Alert Status
  status                    EmergencyAlertStatus  @default(ACTIVE)
  priority                  EmergencyAlertPriority @default(CRITICAL)
  
  // Acknowledgments
  acknowledgedBy            String?               // JSON array of staff who acknowledged
  managerAcknowledged       Boolean               @default(false)
  managerAcknowledgedAt     DateTime?
  
  anesthetistAcknowledged   Boolean               @default(false)
  anesthetistAcknowledgedAt DateTime?
  anesthetistId             String?
  
  nurseAcknowledged         Boolean               @default(false)
  nurseAcknowledgedAt       DateTime?
  
  // Display Settings
  displayOnTv               Boolean               @default(true)
  tvAcknowledgedAt          DateTime?
  autoHideAfterMinutes      Int                   @default(60)
  
  // Special Requirements
  bloodRequired             Boolean               @default(false)
  bloodUnits                Int?
  specialEquipment          String?               // JSON array
  
  // Status Updates
  allStaffReady             Boolean               @default(false)
  theatreReady              Boolean               @default(false)
  patientInTheatre          Boolean               @default(false)
  
  // Escalation (for alerts not acknowledged within 15 minutes)
  escalatedAt               DateTime?
  escalatedToAdmins         Boolean               @default(false)
  
  // Resolution
  resolvedAt                DateTime?
  resolutionNotes           String?
  
  // Cancellation
  cancelledAt               DateTime?
  cancellationReason        String?
  
  // Alert Details
  alertMessage              String?
  additionalNotes           String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  surgery                   Surgery               @relation("EmergencyAlerts", fields: [surgeryId], references: [id])
  surgeon                   User?                 @relation("SurgeonEmergencyAlerts", fields: [surgeonId], references: [id])
  anesthetist               User?                 @relation("AnesthetistEmergencyAlerts", fields: [anesthetistId], references: [id])
  
  @@map("emergency_surgery_alerts")
}

// User Notifications
model Notification {
  id          String    @id @default(uuid())
  userId      String
  type        String    // EMERGENCY_ESCALATION, SURGERY_ASSIGNED, etc.
  title       String
  message     String
  link        String?
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  
  user        User      @relation(fields: [userId], references: [id])
  
  @@map("notifications")
}

// TV Alert Display Log (for tracking what alerts were shown)
model TvAlertDisplayLog {
  id                        String                @id @default(uuid())
  
  alertId                   String
  alertType                 String                // EMERGENCY_SURGERY, EQUIPMENT_FAULT, etc.
  
  displayedAt               DateTime              @default(now())
  dismissedAt               DateTime?
  
  displayDurationSeconds    Int?
  tvLocation                String?               // e.g., "Main Theatre Corridor", "Recovery Room"
  
  acknowledgedBy            String?               // Staff who dismissed alert
  
  createdAt                 DateTime              @default(now())
  
  @@map("tv_alert_display_logs")
}


// =======================
// CSSD MODULE
// =======================

enum SterileMaterialStatus {
  AVAILABLE
  IN_USE
  BEING_STERILIZED
  AWAITING_STERILIZATION
  QUARANTINED
  DAMAGED
}

enum SurgicalPackType {
  MAJOR_BUNDLE
  MINOR_BUNDLE
  INSTRUMENT_SET
  OPERATING_GOWN
  DRAPE_SET
  SPECIALIZED_KIT
}

model CssdInventory {
  id                    String                  @id @default(uuid())
  
  itemName              String
  itemCode              String                  @unique
  packType              SurgicalPackType
  surgicalUnit          String                  // e.g., General Surgery, Orthopedics, etc.
  
  totalQuantity         Int
  availableQuantity     Int
  inUseQuantity         Int
  sterilizingQuantity   Int
  
  minimumStockLevel     Int                     @default(5)
  
  status                SterileMaterialStatus   @default(AVAILABLE)
  lastSterilizedDate    DateTime?
  expiryDate            DateTime?
  
  location              String?                 // Storage location in CSSD
  supplierName          String?
  
  notes                 String?
  
  updatedById           String
  updatedBy             User                    @relation(fields: [updatedById], references: [id])
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  usageHistory          CssdUsageHistory[]
  sterilizationLogs     CssdSterilizationLog[]
  
  @@map("cssd_inventory")
}

model CssdUsageHistory {
  id                    String                  @id @default(uuid())
  
  inventoryId           String
  inventory             CssdInventory           @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  surgeryId             String?
  surgery               Surgery?                @relation(fields: [surgeryId], references: [id])
  
  quantityIssued        Int
  quantityReturned      Int?
  
  issuedToWard          String?
  issuedToTheatre       String?
  
  issuedById            String
  issuedBy              User                    @relation("IssuedBy", fields: [issuedById], references: [id])
  
  returnedById          String?
  returnedBy            User?                   @relation("ReturnedBy", fields: [returnedById], references: [id])
  
  issuedAt              DateTime                @default(now())
  returnedAt            DateTime?
  
  purpose               String?
  notes                 String?
  
  @@map("cssd_usage_history")
}

model CssdSterilizationLog {
  id                    String                  @id @default(uuid())
  
  inventoryId           String
  inventory             CssdInventory           @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  batchNumber           String
  sterilizationMethod   String                  // e.g., Autoclave, ETO, Plasma
  
  quantity              Int
  
  startedAt             DateTime
  completedAt           DateTime?
  
  temperature           String?
  pressure              String?
  cycleTime             Int?                    // in minutes
  
  biologicalIndicator   Boolean                 @default(false)
  chemicalIndicator     Boolean                 @default(false)
  
  operatorId            String
  operator              User                    @relation(fields: [operatorId], references: [id])
  
  verifiedById          String?
  verifiedBy            User?                   @relation("VerifiedBy", fields: [verifiedById], references: [id])
  
  status                String                  // SUCCESSFUL, FAILED, IN_PROGRESS
  failureReason         String?
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  
  @@map("cssd_sterilization_logs")
}

model CssdReadinessReport {
  id                    String                  @id @default(uuid())
  
  reportDate            DateTime                @default(now())
  shiftType             String                  // MORNING, AFTERNOON, NIGHT
  
  // Overall readiness
  overallStatus         String                  // READY, PARTIALLY_READY, NOT_READY
  readinessPercentage   Int
  
  // Stock levels
  majorBundlesAvailable Int
  minorBundlesAvailable Int
  gownsAvailable        Int
  
  // Issues and notes
  criticalShortages     String?
  equipmentIssues       String?
  actionTaken           String?
  
  reportedById          String
  reportedBy            User                    @relation(fields: [reportedById], references: [id])
  
  approvedById          String?
  approvedBy            User?                   @relation("ApprovedBy", fields: [approvedById], references: [id])
  
  approvedAt            DateTime?
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("cssd_readiness_reports")
}

// =======================
// POWER HOUSE MODULE
// =======================

enum PowerStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  FAILED
}

enum PowerSource {
  MAINS_POWER
  GENERATOR
  SOLAR
  UPS
}

model PowerHouseStatus {
  id                    String                  @id @default(uuid())
  
  // Current power status
  currentSource         PowerSource
  mainsPowerStatus      PowerStatus
  generatorStatus       PowerStatus
  solarStatus           PowerStatus
  upsStatus             PowerStatus
  
  // Voltage and frequency
  mainsVoltage          String?
  mainsFrequency        String?
  generatorVoltage      String?
  generatorFrequency    String?
  
  // Fuel levels
  dieselLevel           Int                     // Percentage 0-100
  dieselCapacity        Int                     // In liters
  dieselQuantity        Int                     // Current quantity in liters
  
  // Generator details
  generatorRuntime      Int?                    // Hours
  generatorLoadPercent  Int?                    // Percentage 0-100
  
  // Solar details
  solarCharge           Int?                    // Percentage 0-100
  solarOutput           String?                 // e.g., "5.2 kW"
  
  // UPS details
  upsBatteryLevel       Int?                    // Percentage 0-100
  upsRuntime            Int?                    // Minutes remaining
  
  // Issues and alerts
  criticalAlerts        String?
  warningAlerts         String?
  
  // Operational
  lastMaintenanceDate   DateTime?
  nextMaintenanceDate   DateTime?
  
  operatorId            String
  operator              User                    @relation(fields: [operatorId], references: [id])
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  fuelConsumption       PowerFuelConsumption[]
  maintenanceLogs       PowerMaintenanceLog[]
  
  @@map("power_house_status")
}

model PowerFuelConsumption {
  id                    String                  @id @default(uuid())
  
  statusId              String
  status                PowerHouseStatus        @relation(fields: [statusId], references: [id], onDelete: Cascade)
  
  consumptionDate       DateTime                @default(now())
  
  dieselConsumed        Int                     // In liters
  
  generatorRunHours     Float
  
  averageLoad           Int?                    // Percentage
  
  recordedById          String
  recordedBy            User                    @relation(fields: [recordedById], references: [id])
  
  notes                 String?
  
  @@map("power_fuel_consumption")
}

model PowerMaintenanceLog {
  id                    String                  @id @default(uuid())
  
  statusId              String
  status                PowerHouseStatus        @relation(fields: [statusId], references: [id], onDelete: Cascade)
  
  maintenanceType       String                  // ROUTINE, PREVENTIVE, CORRECTIVE, EMERGENCY
  maintenanceDate       DateTime                @default(now())
  
  componentServiced     String
  workPerformed         String
  
  partsReplaced         String?
  partsCost             Float?
  
  technicianId          String
  technician            User                    @relation(fields: [technicianId], references: [id])
  
  supervisorId          String?
  supervisor            User?                   @relation("Supervisor", fields: [supervisorId], references: [id])
  
  nextServiceDate       DateTime?
  
  maintenanceStatus     String                  // COMPLETED, PENDING, IN_PROGRESS
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("power_maintenance_logs")
}

model PowerReadinessReport {
  id                    String                  @id @default(uuid())
  
  reportDate            DateTime                @default(now())
  shiftType             String                  // MORNING, AFTERNOON, NIGHT
  
  // Overall readiness
  overallStatus         String                  // READY, PARTIALLY_READY, NOT_READY, CRITICAL
  
  // Power availability
  mainsPowerAvailable   Boolean
  generatorAvailable    Boolean
  solarAvailable        Boolean
  upsAvailable          Boolean
  
  // Fuel status
  dieselAvailable       Boolean
  dieselPercentage      Int
  estimatedRuntimeHours Int?
  
  // Critical information
  criticalIssues        String?
  actionTaken           String?
  
  reportedById          String
  reportedBy            User                    @relation(fields: [reportedById], references: [id])
  
  approvedById          String?
  approvedBy            User?                   @relation("ApprovedBy", fields: [approvedById], references: [id])
  
  approvedAt            DateTime?
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("power_readiness_reports")
}

// ============================================
// NEW MODULES - INCIDENT REPORTING, LAUNDRY, WATER, SUB-STORES, INVESTIGATIONS, MEALS
// ============================================

model IncidentReport {
  id                    String                  @id @default(uuid())
  
  incidentDate          DateTime                @default(now())
  incidentType          IncidentType
  severity              IncidentSeverity
  status                IncidentStatus          @default(REPORTED)
  
  location              String                  // Theatre number or specific location
  description           String                  // Detailed description of incident
  
  // People involved
  reportedById          String
  reportedBy            User                    @relation("IncidentReporter", fields: [reportedById], references: [id])
  
  witnessesPresent      Boolean                 @default(false)
  witnessNames          String?                 // Comma-separated or JSON
  
  // Injuries/Damages
  injuriesReported      Boolean                 @default(false)
  injuryDetails         String?
  damagesReported       Boolean                 @default(false)
  damageDetails         String?
  
  // Investigation
  investigationRequired Boolean                 @default(true)
  investigatedById      String?
  investigatedBy        User?                   @relation("IncidentInvestigator", fields: [investigatedById], references: [id])
  investigationNotes    String?
  investigationDate     DateTime?
  
  // Verification
  verifiedById          String?
  verifiedBy            User?                   @relation("IncidentVerifier", fields: [verifiedById], references: [id])
  verifiedAt            DateTime?
  verificationNotes     String?
  
  // Prevention measures
  preventionMeasures    String?                 // Detailed prevention recommendations
  actionTaken           String?
  responsiblePerson     String?
  
  // Follow-up
  followUpRequired      Boolean                 @default(false)
  followUpDate          DateTime?
  followUpNotes         String?
  
  attachments           String?                 // JSON array of file paths
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("incident_reports")
}

model LaundryReadiness {
  id                    String                  @id @default(uuid())
  
  reportDate            DateTime                @default(now())
  shiftType             String                  // MORNING, AFTERNOON, NIGHT
  
  // Linen inventory
  surgicalGownsClean    Int                     @default(0)
  surgicalDrapesClean   Int                     @default(0)
  patientGownsClean     Int                     @default(0)
  bedSheetsClean        Int                     @default(0)
  towelsClean           Int                     @default(0)
  scrubSuitsClean       Int                     @default(0)
  
  // Theatre-specific allocation
  theatre1Allocated     Boolean                 @default(false)
  theatre2Allocated     Boolean                 @default(false)
  theatre3Allocated     Boolean                 @default(false)
  theatre4Allocated     Boolean                 @default(false)
  
  // Overall status
  overallReadiness      String                  // READY, PARTIALLY_READY, NOT_READY, CRITICAL
  criticalShortages     String?                 // Items critically low
  
  // Collected/Used
  surgicalGownsUsed     Int                     @default(0)
  surgicalDrapesUsed    Int                     @default(0)
  patientGownsUsed      Int                     @default(0)
  
  notes                 String?
  
  reportedById          String
  reportedBy            User                    @relation(fields: [reportedById], references: [id])
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("laundry_readiness")
}

model WaterSupplyLog {
  id                    String                  @id @default(uuid())
  
  logDate               DateTime                @default(now())
  shiftType             String                  // MORNING, AFTERNOON, NIGHT
  
  // Water availability
  mainWaterSupply       Boolean
  boreholeActive        Boolean
  tankWaterLevel        Int                     // Percentage 0-100
  
  // Quality checks
  waterPressure         String                  // LOW, NORMAL, HIGH
  waterQuality          String                  // CLEAR, CLOUDY, CONTAMINATED
  chlorineLevelTested   Boolean                 @default(false)
  chlorineLevel         String?                 // ppm measurement
  
  // Theatre-specific supply
  theatre1WaterOk       Boolean                 @default(false)
  theatre2WaterOk       Boolean                 @default(false)
  theatre3WaterOk       Boolean                 @default(false)
  theatre4WaterOk       Boolean                 @default(false)
  
  scrubSinksFunctional  Boolean                 @default(true)
  
  // Plumbing issues
  leaksReported         Boolean                 @default(false)
  leakLocations         String?
  
  blockagesReported     Boolean                 @default(false)
  blockageLocations     String?
  
  maintenanceRequired   Boolean                 @default(false)
  maintenanceDetails    String?
  
  // Overall readiness
  overallStatus         String                  // READY, PARTIALLY_READY, NOT_READY, CRITICAL
  
  actionTaken           String?
  notes                 String?
  
  loggedById            String
  loggedBy              User                    @relation(fields: [loggedById], references: [id])
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("water_supply_logs")
}

model TheatreSubStore {
  id                    String                  @id @default(uuid())
  
  theatreNumber         String                  // THEATRE_1, THEATRE_2, etc.
  theatreName           String?                 // Human-readable theatre name
  itemName              String
  itemCode              String?
  category              String                  // CONSUMABLE, DEVICE, MEDICATION, EQUIPMENT
  
  currentStock          Int                     @default(0)
  minimumStock          Int                     @default(10)
  maximumStock          Int                     @default(100)
  
  unit                  String                  // pieces, boxes, vials, etc.
  unitPrice             Decimal?                @db.Decimal(10, 2)
  
  // Item tracking
  batchNumber           String?
  expiryDate            DateTime?
  
  // Scrub nurse management
  managedById           String
  managedBy             User                    @relation("SubStoreManager", fields: [managedById], references: [id])
  
  // Stock status
  lastRestocked         DateTime?
  lastUsed              DateTime?
  
  stockStatus           String                  // ADEQUATE, LOW, CRITICAL, OUT_OF_STOCK
  
  // Readiness tracking
  morningCheckDone      Boolean                 @default(false)
  morningCheckById      String?
  morningCheckBy        User?                   @relation("MorningCheck", fields: [morningCheckById], references: [id])
  morningCheckDate      DateTime?
  
  endOfDayCheckDone     Boolean                 @default(false)
  endOfDayCheckById     String?
  endOfDayCheckBy       User?                   @relation("EndOfDayCheck", fields: [endOfDayCheckById], references: [id])
  endOfDayCheckDate     DateTime?
  
  reorderRequested      Boolean                 @default(false)
  reorderRequestDate    DateTime?
  
  stockTransfers        StockTransfer[]
  usageLogs             SubStoreUsageLog[]
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@unique([theatreNumber, itemName])
  @@map("theatre_sub_stores")
}

// Sub-store consumable usage log - tracks items used during surgeries
model SubStoreUsageLog {
  id                    String                  @id @default(uuid())
  
  // Sub-store item reference
  subStoreId            String
  subStore              TheatreSubStore         @relation(fields: [subStoreId], references: [id])
  
  // Theatre info
  theatreNumber         String
  theatreName           String?
  
  // Surgery/Case info
  surgeryId             String?
  patientName           String?
  patientFolderNumber   String?
  procedureName         String?
  
  // Usage details
  itemName              String
  quantityUsed          Int
  quantityReturned      Int                     @default(0)
  quantityWasted        Int                     @default(0)
  netQuantityConsumed   Int?                    // Calculated: used - returned
  
  // Waste tracking
  wasteReason           String?
  
  // Staff
  usedById              String
  usedBy                User                    @relation("UsageLoggedBy", fields: [usedById], references: [id])
  usedByName            String
  
  // Timing
  usedAt                DateTime                @default(now())
  returnedAt            DateTime?
  
  // Verification
  verifiedById          String?
  verifiedBy            User?                   @relation("UsageVerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt            DateTime?
  
  // Notes
  usageNotes            String?
  returnNotes           String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("sub_store_usage_logs")
}

// Restock requests from scrub nurse to theatre manager
model SubStoreRestockRequest {
  id                    String                  @id @default(uuid())
  
  // Request reference
  requestNumber         String                  @unique
  
  // Theatre/Store info
  theatreNumber         String
  theatreName           String?
  
  // Urgency
  urgency               String                  @default("NORMAL") // LOW, NORMAL, HIGH, CRITICAL
  
  // Status
  status                String                  @default("PENDING") // PENDING, APPROVED, FULFILLED, PARTIALLY_FULFILLED, REJECTED
  
  // Requested By (Scrub Nurse)
  requestedById         String
  requestedBy           User                    @relation("RestockRequester", fields: [requestedById], references: [id])
  requestedAt           DateTime                @default(now())
  requestNotes          String?
  
  // Items requested (JSON array)
  itemsRequested        String                  // JSON: [{itemName, quantity, currentStock, reason}]
  
  // Approval (Theatre Manager)
  approvedById          String?
  approvedBy            User?                   @relation("RestockApprover", fields: [approvedById], references: [id])
  approvedAt            DateTime?
  approvalNotes         String?
  rejectionReason       String?
  
  // Fulfillment
  fulfilledById         String?
  fulfilledBy           User?                   @relation("RestockFulfiller", fields: [fulfilledById], references: [id])
  fulfilledAt           DateTime?
  itemsFulfilled        String?                 // JSON: [{itemName, quantityFulfilled}]
  fulfillmentNotes      String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("sub_store_restock_requests")
}

model StockTransfer {
  id                    String                  @id @default(uuid())
  
  transferDate          DateTime                @default(now())
  
  // Transfer type
  transferType          String                  @default("MAIN_TO_SUBSTORE") // MAIN_TO_SUBSTORE, SUBSTORE_TO_SUBSTORE
  
  // Source (main store or another sub-store)
  fromMainStore         Boolean                 @default(true)
  sourceInventoryId     String?                 // Main store inventory item ID (when from main store)
  fromSubStoreId        String?                 // Source sub-store ID (for inter-substore transfers)
  sourceTheatreNumber   String?                 // Source theatre number (for inter-substore transfers)
  
  // Destination (sub-store)
  toSubStoreId          String
  toSubStore            TheatreSubStore         @relation(fields: [toSubStoreId], references: [id])
  destTheatreNumber     String?                 // Destination theatre number
  
  itemName              String
  quantityTransferred   Int
  unit                  String
  
  // Authorization
  requestedById         String
  requestedBy           User                    @relation("TransferRequester", fields: [requestedById], references: [id])
  
  approvedById          String?
  approvedBy            User?                   @relation("TransferApprover", fields: [approvedById], references: [id])
  approvedAt            DateTime?
  
  issuedById            String?
  issuedBy              User?                   @relation("TransferIssuer", fields: [issuedById], references: [id])
  issuedAt              DateTime?
  
  receivedById          String?
  receivedBy            User?                   @relation("TransferReceiver", fields: [receivedById], references: [id])
  receivedAt            DateTime?
  
  status                String                  // REQUESTED, APPROVED, ISSUED, RECEIVED, CANCELLED
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("stock_transfers")
}

model PreoperativeInvestigation {
  id                    String                  @id @default(uuid())
  
  // Patient and surgery details
  surgeryId             String
  surgery               Surgery                 @relation(fields: [surgeryId], references: [id])
  
  patientId             String
  patient               Patient                 @relation(fields: [patientId], references: [id])
  
  // Investigation details
  testName              String                  // FBC, U&E, Chest X-ray, etc.
  testCategory          String                  // HEMATOLOGY, BIOCHEMISTRY, RADIOLOGY, MICROBIOLOGY, etc.
  
  urgency               InvestigationUrgency
  status                InvestigationStatus     @default(REQUESTED)
  
  // Requester
  requestedById         String
  requestedBy           User                    @relation("InvestigationRequester", fields: [requestedById], references: [id])
  requestedAt           DateTime                @default(now())
  
  requestReason         String?                 // Clinical indication
  
  // Laboratory processing
  sampleCollected       Boolean                 @default(false)
  sampleCollectedAt     DateTime?
  sampleCollectedById   String?
  sampleCollectedBy     User?                   @relation("SampleCollector", fields: [sampleCollectedById], references: [id])
  
  receivedByLabAt       DateTime?
  processedByLabAt      DateTime?
  
  // Results
  resultsAvailable      Boolean                 @default(false)
  resultsAvailableAt    DateTime?
  resultValue           String?                 // Test result
  resultUnit            String?
  referenceRange        String?
  
  abnormalResult        Boolean                 @default(false)
  criticalResult        Boolean                 @default(false)
  
  // Verification
  verifiedById          String?
  verifiedBy            User?                   @relation("ResultsVerifier", fields: [verifiedById], references: [id])
  verifiedAt            DateTime?
  
  // Report
  reportAttachment      String?                 // File path or URL
  
  labComments           String?
  clinicalComments      String?
  
  // Surgery readiness impact
  clearedForSurgery     Boolean                 @default(false)
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("preoperative_investigations")
}

model TheatreMeal {
  id                    String                  @id @default(uuid())
  
  mealDate              DateTime                @default(now())
  mealType              String                  // BREAKFAST, LUNCH, DINNER, SNACK
  
  // Auto-generated from logged-in staff
  staffMemberName       String
  staffMemberRole       String
  staffMemberId         String?
  staffMember           User?                   @relation(fields: [staffMemberId], references: [id])
  
  // Meal status
  mealRequested         Boolean                 @default(true)
  mealServed            Boolean                 @default(false)
  mealServedAt          DateTime?
  
  // Special requirements
  dietaryRestrictions   String?                 // Vegetarian, Halal, Allergies, etc.
  specialRequest        String?
  
  // Cafeteria tracking
  preparedById          String?
  preparedBy            User?                   @relation("MealPreparer", fields: [preparedById], references: [id])
  
  confirmed             Boolean                 @default(false)
  confirmedAt           DateTime?
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("theatre_meals")
}

// ============================================
// OXYGEN CONTROL ROOM MODULE
// ============================================

model OxygenReadinessReport {
  id                    String                  @id @default(uuid())
  
  reportDate            DateTime                @default(now())
  shiftType             String                  // MORNING, AFTERNOON, NIGHT
  
  // Central oxygen supply
  centralOxygenPressure Float                   // Pressure in PSI
  centralOxygenStatus   OxygenSupplyStatus
  cylinderBankLevel     Int                     // Percentage 0-100
  
  // Backup systems
  backupCylindersCount  Int                     @default(0)
  backupCylindersStatus OxygenSupplyStatus
  manifoldSystemOk      Boolean                 @default(true)
  pipelineIntegrityOk   Boolean                 @default(true)
  
  // Theatre-specific oxygen availability
  theatre1OxygenOk      Boolean                 @default(false)
  theatre1Pressure      Float?                  // Pressure at theatre outlet
  theatre2OxygenOk      Boolean                 @default(false)
  theatre2Pressure      Float?
  theatre3OxygenOk      Boolean                 @default(false)
  theatre3Pressure      Float?
  theatre4OxygenOk      Boolean                 @default(false)
  theatre4Pressure      Float?
  
  // Recovery room oxygen
  recoveryRoomOxygenOk  Boolean                 @default(false)
  recoveryRoomPressure  Float?
  
  // Alarm systems
  alarmSystemFunctional Boolean                 @default(true)
  lowPressureAlarmOk    Boolean                 @default(true)
  highPressureAlarmOk   Boolean                 @default(true)
  
  // Shortage prediction
  predictedShortage     Boolean                 @default(false)
  shortageEstimatedTime String?                 // E.g., "6 hours", "2 days"
  shortageReason        String?
  
  // Maintenance
  lastMaintenanceDate   DateTime?
  nextMaintenanceDate   DateTime?
  maintenanceRequired   Boolean                 @default(false)
  maintenanceDetails    String?
  
  // Overall status
  overallReadiness      String                  // READY, PARTIALLY_READY, NOT_READY, CRITICAL
  criticalIssues        String?
  
  actionTaken           String?
  recommendations       String?
  notes                 String?
  
  // Reporting
  reportedById          String
  reportedBy            User                    @relation(fields: [reportedById], references: [id])
  
  verifiedById          String?
  verifiedBy            User?                   @relation("OxygenReportVerifier", fields: [verifiedById], references: [id])
  verifiedAt            DateTime?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("oxygen_readiness_reports")
}

model OxygenAlert {
  id                    String                  @id @default(uuid())
  
  alertDate             DateTime                @default(now())
  alertType             String                  // DEPLETION, LOW_PRESSURE, SYSTEM_FAILURE, CYLINDER_EMPTY
  severity              OxygenAlertSeverity
  status                OxygenAlertStatus       @default(ACTIVE)
  
  // Location
  location              String                  // Specific theatre or location
  affectedTheatres      String?                 // Comma-separated theatre numbers
  
  // Alert details
  currentPressure       Float?                  // Current oxygen pressure
  normalPressure        Float?                  // Expected normal pressure
  oxygenLevel           Float?                  // Percentage or volume
  
  description           String                  // Detailed description
  immediateRisk         Boolean                 @default(false)  // Is there an active surgery at risk?
  activeSurgeryId       String?                 // Link to affected surgery
  activeSurgery         Surgery?                @relation(fields: [activeSurgeryId], references: [id])
  
  // Alert trigger
  triggeredById         String
  triggeredBy           User                    @relation("OxygenAlertTriggerer", fields: [triggeredById], references: [id])
  triggerReason         String                  // Why alert was raised
  
  // Response tracking
  acknowledgedById      String?
  acknowledgedBy        User?                   @relation("OxygenAlertAcknowledger", fields: [acknowledgedById], references: [id])
  acknowledgedAt        DateTime?
  
  respondedById         String?
  respondedBy           User?                   @relation("OxygenAlertResponder", fields: [respondedById], references: [id])
  respondedAt           DateTime?
  responseAction        String?                 // Action taken
  
  resolvedById          String?
  resolvedBy            User?                   @relation("OxygenAlertResolver", fields: [resolvedById], references: [id])
  resolvedAt            DateTime?
  resolutionNotes       String?
  
  // Impact assessment
  surgeriesAffected     Int                     @default(0)
  patientsAffected      Int                     @default(0)
  downtime              Int?                    // Minutes of oxygen unavailability
  
  // Follow-up
  preventativeMeasures  String?
  rootCause             String?
  
  notes                 String?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@map("oxygen_alerts")
}

// ============================================
// DISCIPLINARY QUERY SYSTEM
// Auto-generated queries for deadline non-compliance
// ============================================

enum DisciplinaryQueryStatus {
  ISSUED
  ACKNOWLEDGED
  RESPONDED
  ESCALATED
  RESOLVED
  DISMISSED
}

enum DisciplinaryQueryType {
  READINESS_LATE
  THEATRE_SETUP_LATE
  DUTY_ABANDONMENT
  PROTOCOL_VIOLATION
  OTHER
}

model DisciplinaryQuery {
  id                    String                   @id @default(uuid())
  referenceNumber       String                   @unique
  recipientId           String
  recipientName         String
  recipientRole         String
  recipientUnit         String
  queryType             DisciplinaryQueryType
  subject               String
  description           String
  deadlineTime          DateTime
  deadlineType          String
  evidence              String?
  status                DisciplinaryQueryStatus  @default(ISSUED)
  recipientResponse     String?
  respondedAt           DateTime?
  escalatedTo           String?
  escalatedAt           DateTime?
  escalationReason      String?
  resolvedAt            DateTime?
  resolution            String?
  issuedById            String?
  issuedByName          String                   @default("Office of the Chief Medical Director")
  issuedByTitle         String                   @default("University of Nigeria Teaching Hospital, Ituku Ozalla")
  recipient             User                     @relation("QueryRecipient", fields: [recipientId], references: [id])
  issuedBy              User?                    @relation("QueryIssuer", fields: [issuedById], references: [id])
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  
  @@map("disciplinary_queries")
}

// ========================
// Emergency Team Availability
// ========================

enum EmergencyTeamRole {
  SURGEON
  ANAESTHETIST
  SCRUB_NURSE
  CIRCULATING_NURSE
  ANAESTHETIC_TECHNICIAN
  PORTER
  RECOVERY_ROOM_NURSE
  THEATRE_STORE_KEEPER
  BIOMEDICAL_ENGINEER
  CLEANER
  BLOODBANK_STAFF
  PHARMACIST
}

enum AvailabilityStatus {
  AVAILABLE
  EN_ROUTE
  ARRIVED
  UNAVAILABLE
  ON_ANOTHER_CASE
}

model EmergencyTeamAvailability {
  id                    String              @id @default(uuid())
  emergencyBookingId    String
  userId                String
  userName              String
  teamRole              EmergencyTeamRole
  status                AvailabilityStatus  @default(AVAILABLE)
  
  // Geo-location
  latitude              Float?
  longitude             Float?
  locationTimestamp     DateTime?
  estimatedArrivalMin   Int?                // Estimated minutes to arrive
  distanceKm            Float?              // Calculated distance to hospital
  
  // Timestamps
  respondedAt           DateTime            @default(now())
  arrivedAt             DateTime?
  
  // Notes
  notes                 String?
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  emergencyBooking      EmergencySurgeryBooking @relation(fields: [emergencyBookingId], references: [id])
  user                  User                @relation(fields: [userId], references: [id])
  
  @@unique([emergencyBookingId, userId])
  @@index([emergencyBookingId, teamRole])
  @@map("emergency_team_availability")
}

// ========================
// Emergency Pre-Anaesthetic Review & Prescription
// ========================

enum EmergencyReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  APPROVED
}

enum EmergencyPrescriptionStatus {
  DRAFT
  SUBMITTED
  PHARMACIST_VIEWED
  PACKING
  PACKED
  DISPENSED
  OUT_OF_STOCK_FLAGGED
}

model EmergencyPreAnaestheticReview {
  id                    String                    @id @default(uuid())
  emergencyBookingId    String
  surgeryId             String?
  patientName           String
  folderNumber          String
  
  // Reviewer
  reviewerId            String
  reviewerName          String
  
  // Assessment
  airwayAssessment      String?             // Mallampati, Neck mobility, etc.
  asaClassification     String?             // ASA I-VI
  allergies             String?
  currentMedications    String?
  pastMedicalHistory    String?
  lastMealTime          DateTime?           // Fasting status for emergency
  
  // Vitals
  bloodPressure         String?
  heartRate             Int?
  oxygenSaturation      Float?
  temperature           Float?
  weight                Float?
  height                Float?
  bmi                   Float?
  
  // Emergency-Specific
  estimatedBloodLoss    String?
  coagulationStatus     String?
  hemoglobinLevel       Float?
  crossMatchStatus      String?
  ivAccess              String?             // Details of IV lines
  patientNPOStatus      String?             // NPO status for emergency
  
  // Anaesthetic Plan
  anaestheticPlan       String?             // General, Regional, Combined, etc.
  specialConsiderations String?
  riskAssessment        String?
  consentObtained       Boolean             @default(false)
  consentNotes          String?
  
  // Approval (by a consultant)
  approvedById          String?
  approvedByName        String?
  approvedAt            DateTime?
  
  // Status
  status                EmergencyReviewStatus @default(PENDING)
  isEmergency           Boolean             @default(true)
  
  // Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  emergencyBooking      EmergencySurgeryBooking @relation(fields: [emergencyBookingId], references: [id])
  reviewer              User                @relation("EmergencyReviewer", fields: [reviewerId], references: [id])
  approvedBy            User?               @relation("EmergencyReviewApprover", fields: [approvedById], references: [id])
  prescriptions         EmergencyPrescription[]
  
  @@map("emergency_pre_anaesthetic_reviews")
}

model EmergencyPrescription {
  id                    String                      @id @default(uuid())
  reviewId              String
  emergencyBookingId    String
  patientName           String
  folderNumber          String
  
  // Prescriber info (carried from review)
  prescribedByName      String
  
  // Medications
  medications           String                      // JSON: [{name, dose, route, frequency, timing, isEmergency}]
  fluids                String?                     // JSON: IV fluids
  emergencyDrugs        String?                     // JSON: emergency drugs
  
  // Allergy Alerts (for pharmacist)
  allergyAlerts         String?
  specialInstructions   String?
  
  // Urgency Flag
  isEmergency           Boolean                     @default(true)
  urgencyNote           String?                     @default("EMERGENCY - IMMEDIATE DISPENSING REQUIRED")
  
  // Pharmacist tracking
  viewedByPharmacist    Boolean                     @default(false)
  viewedAt              DateTime?
  
  packedById            String?
  packedByName          String?
  packedAt              DateTime?
  packingNotes          String?
  
  // Out-of-stock
  outOfStockItems       String?                     // JSON: items out of stock
  hasOutOfStockItems    Boolean                     @default(false)
  
  // Status
  status                EmergencyPrescriptionStatus @default(DRAFT)
  
  // Audit
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  
  // Relations
  review                EmergencyPreAnaestheticReview @relation(fields: [reviewId], references: [id])
  emergencyBooking      EmergencySurgeryBooking     @relation(fields: [emergencyBookingId], references: [id])
  packedBy              User?                       @relation("EmergencyPrescriptionPacker", fields: [packedById], references: [id])
  
  @@map("emergency_prescriptions")
}

// ==========================================
// CALL FOR PATIENT MODULE
// ==========================================

enum CallUpStatus {
  INVITED
  REJECTED
  PATIENT_EN_ROUTE
  PATIENT_ARRIVED
  CANCELLED
}

model PatientCallUp {
  id                    String          @id @default(uuid())
  
  // Surgery reference
  surgeryId             String
  surgery               Surgery         @relation(fields: [surgeryId], references: [id])
  
  // Patient info (denormalized for call-up note)
  patientName           String
  folderNumber          String
  ward                  String?
  age                   Int?
  gender                String?
  diagnosis             String?
  procedureName         String
  surgicalUnit          String
  
  // Theatre info
  theatreName           String
  theatreId             String?
  
  // Assigned staff (from roster/allocation for the theatre)
  assignedNurseName     String?
  assignedNurseId       String?
  assignedPorterName    String?
  assignedPorterId      String?
  
  // Surgeon info
  surgeonName           String
  
  // Status
  status                CallUpStatus    @default(INVITED)
  
  // Invite
  invitedAt             DateTime        @default(now())
  invitedById           String
  invitedBy             User            @relation("CallUpInviter", fields: [invitedById], references: [id])
  invitedByName         String
  
  // Reject (if rejected)
  rejectedAt            DateTime?
  rejectedById          String?
  rejectedBy            User?           @relation("CallUpRejecter", fields: [rejectedById], references: [id])
  rejectedByName        String?
  rejectionReason       String?
  
  // Patient arrival tracking
  patientEnRouteAt      DateTime?
  patientArrivedAt      DateTime?
  
  // Call-up note reference number
  callUpNoteNumber      String          @unique @default(uuid())
  
  // Audit
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@index([surgeryId])
  @@index([status])
  @@index([invitedAt])
  @@map("patient_call_ups")
}

// ==========================================
// PRE-OPERATIVE VISIT MODULE
// ==========================================

enum PreOpVisitStatus {
  PENDING
  VISITED
  CLEARED
  NOT_CLEARED
  DEFERRED
}

enum PaymentStatus {
  NOT_PAID
  PARTIALLY_PAID
  FULLY_PAID
  WAIVED
  UNKNOWN
}

enum ConsentStatus {
  NOT_OBTAINED
  OBTAINED
  REFUSED
  PENDING
}

enum NPOStatus {
  NPO_COMPLIANT
  NOT_FASTING
  UNKNOWN
  PARTIALLY_COMPLIANT
}

enum EmotionalReadiness {
  READY
  ANXIOUS
  VERY_ANXIOUS
  REFUSED
  NEEDS_COUNSELLING
  UNKNOWN
}

model PreOperativeVisit {
  id                    String            @id @default(uuid())
  
  // Surgery reference
  surgeryId             String
  surgery               Surgery           @relation(fields: [surgeryId], references: [id])
  
  // Patient info (denormalized for display)
  patientName           String
  folderNumber          String
  ward                  String?
  age                   Int?
  gender                String?
  
  // Booked surgery details
  procedureName         String
  surgicalUnit          String
  scheduledDate         DateTime
  scheduledTime         String
  surgeonName           String
  
  // Visit details
  visitDate             DateTime          @default(now())
  visitedById           String
  visitedBy             User              @relation("PreOpVisitor", fields: [visitedById], references: [id])
  visitedByName         String
  
  // Assessment fields
  patientAvailableInWard  Boolean         @default(false)
  patientLocationNotes    String?         // If patient not in ward
  
  surgicalFeePaymentStatus PaymentStatus  @default(UNKNOWN)
  paymentNotes            String?
  
  consentStatus           ConsentStatus   @default(PENDING)
  consentNotes            String?
  
  surgicalItemsAvailable  Boolean         @default(false)
  itemsAvailabilityNotes  String?         // List of missing items
  
  preAnaestheticReviewDone Boolean        @default(false)
  preAnaestheticNotes     String?
  
  npoStatus               NPOStatus      @default(UNKNOWN)
  npoNotes                String?
  lastMealTime            String?
  
  investigationsComplete  Boolean         @default(false)
  investigationNotes      String?         // Pending/abnormal results
  pendingInvestigations   String?         // JSON list of pending investigations
  
  patientEmotionalReadiness EmotionalReadiness @default(UNKNOWN)
  emotionalReadinessNotes String?
  
  // Blood readiness
  bloodReady              Boolean         @default(false)
  bloodNotes              String?
  
  // IV line
  ivLineSecured           Boolean         @default(false)
  ivLineNotes             String?
  
  // Skin preparation
  skinPrepDone            Boolean         @default(false)
  skinPrepNotes           String?
  
  // Overall status
  overallStatus           PreOpVisitStatus @default(PENDING)
  overallNotes            String?         @db.Text
  
  // Signature / confirmation
  nurseSignature          String?
  
  // Audit
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  
  @@index([surgeryId])
  @@index([visitDate])
  @@index([overallStatus])
  @@map("pre_operative_visits")
}

// ==================== MEDICATION TRACKING & RECONCILIATION ====================

// Track when anaesthetist collects medications from pharmacy
model MedicationCollection {
  id                        String                @id @default(uuid())
  prescriptionId            String
  surgeryId                 String
  
  // Collection Info
  collectedById             String                // Anaesthetist who collected
  collectedByName           String
  collectedAt               DateTime              @default(now())
  
  // Dispensing pharmacist
  dispensedById             String                // Pharmacist who dispensed
  dispensedByName           String
  
  // Items collected (JSON: array of { drugName, dosage, quantityDispensed })
  itemsCollected            String                // JSON
  
  // Signature
  anaesthetistSignature     Boolean               @default(false)
  pharmacistSignature       Boolean               @default(false)
  
  notes                     String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  surgery                   Surgery               @relation("SurgeryMedicationCollections", fields: [surgeryId], references: [id])
  collectedBy               User                  @relation("MedicationCollector", fields: [collectedById], references: [id])
  dispensedBy               User                  @relation("MedicationDispenser", fields: [dispensedById], references: [id])
  
  @@map("medication_collections")
}

// Track individual drug usage during surgery (linked to anesthesia chart)
model MedicationUsageRecord {
  id                        String                @id @default(uuid())
  prescriptionId            String
  surgeryId                 String
  
  // Drug details
  drugName                  String
  dosage                    String
  route                     String
  
  // Quantity tracking
  quantityDispensed         Int                   // How many units were given to anaesthetist
  quantityAdministered      Int                   @default(0)  // How many used during surgery
  quantityWasted            Int                   @default(0)  // Broken/contaminated
  quantityRemaining         Int                   @default(0)  // Must be returned
  
  // Administration log (JSON array of { time, amount, administeredBy, notes })
  administrationLog         String?               // JSON
  
  // Status
  isFullyUsed               Boolean               @default(false)
  isReturnRequired          Boolean               @default(false)
  isReturned                Boolean               @default(false)
  returnedAt                DateTime?
  returnedQuantity          Int?
  
  // Administered by
  administeredById          String?
  administeredByName        String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  surgery                   Surgery               @relation("SurgeryMedicationUsage", fields: [surgeryId], references: [id])
  
  @@map("medication_usage_records")
}

// Post-surgery medication reconciliation
model MedicationReconciliation {
  id                        String                @id @default(uuid())
  prescriptionId            String                @unique
  surgeryId                 String                @unique
  
  // Reconciliation Details
  reconciledById            String                // Usually anaesthetist or admin
  reconciledByName          String
  reconciledAt              DateTime              @default(now())
  
  // Summary
  totalDrugsDispensed       Int
  totalDrugsUsed            Int
  totalDrugsToReturn        Int
  totalDrugsReturned        Int                   @default(0)
  totalDrugsWasted          Int                   @default(0)
  
  // Reconciliation items (JSON: array of { drugName, dispensed, used, remaining, returned, status })
  reconciliationItems       String                // JSON
  
  // Status
  status                    ReconciliationStatus  @default(PENDING_RETURN)
  
  // Return tracking
  returnDeadline            DateTime?             // Deadline for returning medications
  returnReminder1Sent       Boolean               @default(false)
  returnReminder2Sent       Boolean               @default(false)
  queryIssuedAt             DateTime?
  queryReason               String?
  queryResolvedAt           DateTime?
  queryResolution           String?
  
  notes                     String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  surgery                   Surgery               @relation("SurgeryReconciliation", fields: [surgeryId], references: [id])
  reconciledBy              User                  @relation("ReconciliationUser", fields: [reconciledById], references: [id])
  medicationReturns         MedicationReturn[]
  nonReturnQueries          MedicationNonReturnQuery[]
  
  @@map("medication_reconciliations")
}

// Track medication returns to pharmacy
model MedicationReturn {
  id                        String                @id @default(uuid())
  reconciliationId          String
  prescriptionId            String
  surgeryId                 String
  
  // Return details
  returnedById              String                // Anaesthetist returning
  returnedByName            String
  returnedAt                DateTime              @default(now())
  
  // Received by pharmacist
  receivedById              String                // Pharmacist receiving
  receivedByName            String
  receivedAt                DateTime?
  
  // Items returned (JSON: array of { drugName, quantityReturned, condition, pharmacistNotes })
  itemsReturned             String                // JSON
  
  // Pharmacist verification
  pharmacistVerified        Boolean               @default(false)
  pharmacistNotes           String?
  
  // Discrepancies
  hasDiscrepancy            Boolean               @default(false)
  discrepancyNotes          String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  reconciliation            MedicationReconciliation @relation(fields: [reconciliationId], references: [id])
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  surgery                   Surgery               @relation("SurgeryMedicationReturns", fields: [surgeryId], references: [id])
  returnedBy                User                  @relation("MedicationReturner", fields: [returnedById], references: [id])
  receivedBy                User                  @relation("MedicationReceiver", fields: [receivedById], references: [id])
  
  @@map("medication_returns")
}

// Additional medication requests during surgery (emergency top-up)
model AdditionalMedicationRequest {
  id                        String                @id @default(uuid())
  prescriptionId            String                // Original prescription
  surgeryId                 String
  
  // Requested by anaesthetist
  requestedById             String
  requestedByName           String
  requestedAt               DateTime              @default(now())
  
  // Medications requested (JSON: array of { drugName, dosage, route, quantity, reason })
  medicationsRequested      String                // JSON
  
  // Urgency
  urgency                   MedicationUrgency     @default(EMERGENCY)
  reason                    String                // Clinical reason for additional meds
  
  // Status
  status                    AdditionalMedRequestStatus @default(PENDING)
  
  // Pharmacist response
  acknowledgedById          String?
  acknowledgedByName        String?
  acknowledgedAt            DateTime?
  
  // Packing
  packedById                String?
  packedByName              String?
  packedAt                  DateTime?
  
  // Collection
  collectedAt               DateTime?
  collectedByName           String?
  
  // Alert
  alertSentAt               DateTime?
  walkieTalkieNotified      Boolean               @default(false)
  
  notes                     String?
  pharmacistNotes           String?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  surgery                   Surgery               @relation("SurgeryAdditionalMedRequests", fields: [surgeryId], references: [id])
  requestedBy               User                  @relation("AdditionalMedRequester", fields: [requestedById], references: [id])
  acknowledgedBy            User?                 @relation("AdditionalMedAcknowledger", fields: [acknowledgedById], references: [id])
  packedBy                  User?                 @relation("AdditionalMedPacker", fields: [packedById], references: [id])
  
  @@map("additional_medication_requests")
}

// Non-return query tracking
model MedicationNonReturnQuery {
  id                        String                @id @default(uuid())
  reconciliationId          String
  prescriptionId            String
  surgeryId                 String
  
  // Query target
  queriedUserId             String                // Anaesthetist who hasn't returned meds
  queriedUserName           String
  
  // Query details
  issuedById                String                // Admin/pharmacist who raised query
  issuedByName              String
  issuedAt                  DateTime              @default(now())
  
  // Items not returned (JSON: array of { drugName, quantityExpected, quantityReturned, deficit })
  unreturvedItems           String                // JSON
  
  // Deadlines
  responseDeadline          DateTime
  
  // Response
  status                    QueryStatus           @default(PENDING)
  responseText              String?               // Anaesthetist's response/explanation
  respondedAt               DateTime?
  
  // Resolution
  resolvedById              String?
  resolvedByName            String?
  resolvedAt                DateTime?
  resolution                String?               // "RETURNED", "JUSTIFIED_USAGE", "ESCALATED", "WRITTEN_OFF"
  
  // Escalation
  isEscalated               Boolean               @default(false)
  escalatedTo               String?               // HOD, CMD, etc.
  escalatedAt               DateTime?
  
  // Audit
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  // Relations
  reconciliation            MedicationReconciliation @relation(fields: [reconciliationId], references: [id])
  prescription              AnestheticPrescription @relation(fields: [prescriptionId], references: [id])
  surgery                   Surgery               @relation("SurgeryMedicationQueries", fields: [surgeryId], references: [id])
  queriedUser               User                  @relation("QueriedUser", fields: [queriedUserId], references: [id])
  issuedBy                  User                  @relation("QueryIssuer", fields: [issuedById], references: [id])
  
  @@map("medication_non_return_queries")
}

enum ReconciliationStatus {
  PENDING_RETURN
  PARTIALLY_RETURNED
  FULLY_RETURNED
  QUERY_ISSUED
  QUERY_RESOLVED
  CLOSED
}

enum AdditionalMedRequestStatus {
  PENDING
  ACKNOWLEDGED
  PACKING
  PACKED
  COLLECTED
  CANCELLED
}

enum QueryStatus {
  PENDING
  RESPONDED
  UNDER_REVIEW
  RESOLVED
  ESCALATED
}
